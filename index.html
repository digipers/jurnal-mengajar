<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Aplikasi Jurnal Guru Digital</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* CSS UTAMA - DIAMANKAN */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --bg-body: #f1f5f9;
            --bg-sidebar: #0f172a;
            --text-sidebar: #94a3b8;
            --text-sidebar-active: #ffffff;
            --white: #ffffff;
            --border: #e2e8f0;
            --danger: #ef4444;
            --success: #22c55e;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --filter-yellow: #fef08a;
            --filter-text: #854d0e;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-body);
            color: #1e293b;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
        }

        .sidebar {
            width: 260px;
            background-color: var(--bg-sidebar);
            color: var(--text-sidebar);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 1000;
            height: 100%;
        }

        .sidebar-header {
            padding: 20px;
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--white);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-links { 
            list-style: none; 
            padding: 20px 10px; 
            flex: 1; 
            overflow-y: auto;
        }
        
        .nav-item { 
            margin-bottom: 5px; 
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-radius: 8px;
            color: var(--text-sidebar);
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .nav-link:hover, .nav-link.active {
            background-color: var(--primary);
            color: var(--text-sidebar-active);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            position: relative;
        }

        .top-bar {
            background: var(--white);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 10px;
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--primary);
            padding: 5px;
        }

        .page-title { 
            font-weight: 600; 
            font-size: 1.1rem;
            flex: 1;
        }

        /* PERBAIKAN UTAMA: CONTENT AREA HARUS BISA SCROLL */
        .content-area {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            height: calc(100vh - 70px); /* Tinggi viewport minus top bar */
            -webkit-overflow-scrolling: touch; /* Smooth scroll di iOS */
        }

        .section { 
            display: none; 
            animation: fadeIn 0.3s ease;
            max-width: 100%;
            height: auto;
            overflow: visible;
        }
        
        .section.active { 
            display: block; 
            overflow: visible;
            height: auto;
        }

        /* KHUSUS UNTUK SECTION REKAP JURNAL & REKAP ABSEN */
        #rekap-jurnal, #rekap-absen {
            overflow: visible !important;
            height: auto !important;
            min-height: 100%;
        }

        /* PERBAIKAN: KONTEN PRINT HARUS BISA SCROLL */
        .print-content {
            overflow: visible !important;
            width: 100% !important;
            max-width: 100% !important;
            padding: 5mm !important;
            box-sizing: border-box !important;
            background: white !important;
            position: relative;
        }

        .pdf-optimized {
            width: 100% !important;
            max-width: 100% !important;
            padding: 5mm !important;
            box-sizing: border-box !important;
            background: white !important;
            overflow: visible !important;
        }

        .card {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            overflow: visible !important; /* PERUBAHAN PENTING */
            width: 100%;
        }

        /* KHUSUS UNTUK CARD DI SECTION REKAP/REKAP */
        #rekap-jurnal .card,
        #rekap-absen .card {
            overflow: visible !important;
            min-height: auto;
        }

        .card-header {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
            color: #334155;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .filter-group { 
            display: flex; 
            align-items: center; 
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .yellow-select {
            background-color: var(--filter-yellow) !important;
            border: 1px solid #eab308 !important;
            color: var(--filter-text) !important;
            font-weight: 600;
            padding: 8px 12px !important;
            outline: none;
            border-radius: 6px;
            cursor: pointer;
            min-width: 150px;
        }
        
        .yellow-select.month-year-filter {
            min-width: 100px;
            text-align: center;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .form-group { 
            margin-bottom: 15px; 
        }
        
        label { 
            display: block; 
            margin-bottom: 6px; 
            font-weight: 500; 
            font-size: 0.9rem; 
            color: #475569; 
        }
        
        input[type="text"], input[type="date"], input[type="email"], input[type="tel"], select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }
        
        input[type="text"]:focus, input[type="date"]:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            justify-content: center;
            text-decoration: none;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-pdf { background: #dc2626; color: white; }
        .btn-pdf:hover { background: #b91c1c; }
        .btn-print { background: #059669; color: white; }
        .btn-print:hover { background: #047857; }
        
        .backup-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
            border: 2px dashed var(--border);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            background: #f8fafc;
        }

        /* PERBAIKAN SCROLL HORIZONTAL UNTUK TABEL */
        .table-responsive { 
            overflow-x: auto; 
            overflow-y: visible;
            border-radius: 6px; 
            border: 1px solid var(--border);
            margin-bottom: 10px !important;
            max-width: 100%;
            -webkit-overflow-scrolling: touch; /* Smooth scroll di iOS */
            touch-action: pan-x pan-y; /* Enable both horizontal and vertical scroll */
            position: relative;
            width: 100%;
        }
        
        .table-responsive::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        
        .table-responsive::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.9rem; 
            min-width: 600px;
        }
        
        /* TABEL REKAP HARUS BISA SCROLL HORIZONTAL DI HP */
        #recapTable { 
            min-width: auto !important;
            width: auto !important;
        }

        th, td { 
            padding: 8px 10px;
            text-align: left; 
            border-bottom: 1px solid var(--border); 
            vertical-align: top;
        }
        
        th { 
            background-color: #f8fafc; 
            font-weight: 600; 
            color: #64748b; 
            white-space: nowrap; 
        }
        
        tr:hover { background-color: #f1f5f9; }

        #recapTable th:nth-child(n+3),
        #recapTable td:nth-child(n+3) {
            text-align: center;
            width: 25px;
            min-width: 25px;
            max-width: 25px;
            padding: 5px;
        }

        #recapTable th:last-child,
        #recapTable td:last-child {
            width: 80px;
            min-width: 80px;
            max-width: 80px;
        }

        #recapTable tfoot tr {
            font-weight: bold;
            background-color: #e0f2fe;
        }
        
        #recapTable tfoot td {
            border-top: 2px solid var(--primary);
            padding: 10px;
        }

        /* SIGNATURE SECTION */
        .signature-section {
            margin-top: 20px !important;
            padding: 10px 0 !important;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            font-size: 1rem;
            color: #000;
            border-top: 2px solid #000;
            page-break-inside: avoid;
            width: 100%;
            flex-wrap: nowrap;
        }
        
        .sig-block {
            text-align: center;
            min-width: 200px;
            flex: 1;
            margin: 0;
            padding: 0 10px;
        }
        
        .sig-space {
            height: 60px !important;
            margin: 10px 0 !important;
            border-bottom: none;
        }

        .search-container { position: relative; }
        
        .suggestions {
            position: absolute; 
            top: 100%; 
            left: 0; 
            right: 0;
            background: white; 
            border: 1px solid var(--border);
            max-height: 200px; 
            overflow-y: auto; 
            z-index: 50;
            box-shadow: var(--shadow);
            border-radius: 0 0 6px 6px;
        }
        
        .suggestion-item { 
            padding: 10px; 
            cursor: pointer; 
            border-bottom: 1px solid #f1f5f9; 
            display: flex; 
            justify-content: space-between; 
        }
        
        .suggestion-item:hover { background: #f1f5f9; }
        
        .tags-container { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            margin-top: 8px; 
            min-height: 40px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
        }
        
        .tag { 
            background: #e0f2fe; 
            color: #0369a1; 
            padding: 4px 10px; 
            border-radius: 20px; 
            font-size: 0.85rem; 
            font-weight: 600; 
            display: flex; 
            align-items: center; 
            gap: 6px; 
        }
        
        .tag-remove { 
            cursor: pointer; 
            background: #0ea5e9; 
            color: white; 
            border-radius: 50%; 
            width: 16px; 
            height: 16px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 10px; 
        }

        #toast {
            position: fixed; 
            bottom: 20px; 
            right: 20px;
            background: #333; 
            color: white; 
            padding: 12px 24px;
            border-radius: 8px; 
            z-index: 2000; 
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s; 
            pointer-events: none;
            transform: translateY(20px);
            max-width: 300px;
        }
        
        #toast.show { 
            opacity: 1; 
            transform: translateY(0);
        }

        .pdf-loading {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(0,0,0,0.7); 
            color: white;
            z-index: 9999; 
            display: none;
            flex-direction: column;
            align-items: center; 
            justify-content: center;
            text-align: center;
        }
        
        .spinner {
            width: 50px; 
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        .print-header { 
            text-align: center; 
            margin-bottom: 20px !important;
            padding-bottom: 10px; 
            border-bottom: 2px solid #333; 
            width: 100%;
            box-sizing: border-box;
        }
        
        .print-header h2 { font-size: 18pt; text-transform: uppercase; margin: 0; }
        .print-header h3 { font-size: 14pt; margin: 5px 0; text-transform: uppercase; }
        .print-header p { font-size: 11pt; margin: 5px 0; }

        .profile-card {
            text-align: center;
            padding: 30px 20px;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 3rem;
            color: white;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
            overflow: hidden;
            border: 4px solid white;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .profile-subject {
            font-size: 1rem;
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 15px;
        }

        .profile-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
            text-align: left;
        }

        .profile-info-item {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .profile-info-label {
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .profile-info-value {
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 25px;
        }

        .stat-box {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 5px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .photo-upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: #f8fafc;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .photo-upload-area:hover {
            border-color: var(--primary);
            background: #f0f9ff;
        }

        .photo-upload-area i {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .photo-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid white;
            box-shadow: var(--shadow);
            margin: 0 auto 15px;
            display: none;
        }

        /* STYLE KHUSUS UNTUK JURNAL HARI INI - FORMAT TABEL */
        .today-journal-card {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-left: 5px solid var(--primary);
            position: relative;
        }

        .today-journal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .today-date-badge {
            background: var(--primary);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .today-empty-state {
            padding: 40px 20px;
            text-align: center;
            color: #64748b;
            background: #f8fafc;
            border-radius: 8px;
            margin: 20px 0;
        }

        .today-empty-state-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* STYLE UNTUK ABSENSI YANG LEBIH PADAT */
        .absent-list {
            max-height: 100px;
            overflow-y: auto;
            font-size: 0.85rem;
            padding: 5px;
            background: #f8fafc;
            border-radius: 4px;
            margin-top: 5px;
        }

        .absent-list span {
            display: block;
            padding: 2px 0;
            border-bottom: 1px dashed #e2e8f0;
        }

        .absent-list span:last-child {
            border-bottom: none;
        }

        /* STYLE UNTUK STATUS HADIR SEMUA */
        .all-present {
            color: var(--success);
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* PRINT STYLES */
        @media print {
            body * { 
                visibility: hidden; 
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .print-content, .print-content * { 
                visibility: visible !important; 
            }
            
            .print-content { 
                position: absolute !important; 
                left: 0 !important; 
                top: 0 !important; 
                width: 100% !important; 
                height: auto !important;
                overflow: visible !important;
                margin: 0 !important;
                padding: 5mm !important;
                box-sizing: border-box !important;
            }
            
            .no-print { 
                display: none !important; 
            }
            
            body, .main-content, .content-area, .card, table, .signature-section {
                background: white !important; 
                width: 100% !important; 
                height: auto !important; 
                overflow: visible !important; 
                padding: 0 !important; 
                margin: 0 !important; 
                box-shadow: none !important; 
                border: none !important;
                position: static !important;
                display: block !important;
                visibility: visible !important;
            }
            
            .print-header { 
                display: block !important; 
                visibility: visible !important;
                width: 100% !important;
                margin-bottom: 10mm !important;
            }
            
            .signature-section { 
                display: flex !important; 
                visibility: visible !important;
                page-break-inside: avoid !important;
                margin-top: 10mm !important;
                padding: 5mm 0 !important;
                width: 100% !important;
                flex-direction: row !important;
                justify-content: space-between !important;
            }
            
            .sig-space {
                height: 50px !important;
                margin: 5px 0 !important;
            }
            
            table { 
                width: 100% !important; 
                max-width: 100% !important;
                border: 1px solid #000 !important; 
                font-size: 9pt !important;
                table-layout: fixed !important;
            }
            
            th, td { 
                border: 1px solid #000 !important; 
                color: #000 !important; 
                padding: 2px 4px !important;
                word-wrap: break-word !important;
            }
            
            .table-responsive { 
                overflow-x: visible !important; 
                border: none !important;
                width: 100% !important;
                max-width: 100% !important;
                margin-bottom: 5mm !important;
            }
            
            #recapTable {
                font-size: 8pt !important;
                min-width: 100% !important;
            }
            
            #recapTable th:nth-child(n+3),
            #recapTable td:nth-child(n+3) {
                width: 18px !important;
                min-width: 18px !important;
                max-width: 18px !important;
                padding: 1px 2px !important;
            }
            
            @page {
                margin: 5mm;
                size: A4 portrait;
            }
            
            .empty-state {
                display: none !important;
                visibility: hidden !important;
            }
        }

        /* STYLES KHUSUS UNTUK MOBILE */
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -260px; height: 100%; width: 280px; top: 0; }
            .sidebar.open { transform: translateX(260px); }
            .menu-toggle { display: block; }
            .overlay {
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 999; display: none;
            }
            .overlay.active { display: block; }
            .card-header { flex-direction: column; align-items: stretch; }
            .filter-group { flex-direction: column; align-items: stretch; width: 100%; margin-top: 10px; }
            .yellow-select { width: 100%; margin-bottom: 5px; }
            .btn-group { flex-direction: column; width: 100%; }
            .btn { width: 100%; margin-bottom: 5px; }
            .content-area { 
                padding: 15px;
                height: calc(100vh - 60px); /* Adjust for smaller top bar */
            }
            
            /* PERBAIKAN UTAMA: SECTION REKAP/REKAP HARUS BISA SCROLL */
            #rekap-jurnal, #rekap-absen {
                min-height: 100%;
                overflow-y: auto !important;
                overflow-x: hidden !important;
            }
            
            /* CARD DI MOBILE HARUS BISA EXPAND */
            #rekap-jurnal .card,
            #rekap-absen .card {
                min-height: auto;
                overflow: visible !important;
                padding: 15px;
            }
            
            /* TABEL HARUS BISA SCROLL HORIZONTAL */
            .table-responsive {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
                touch-action: pan-x !important;
                width: 100%;
                position: relative;
            }
            
            /* TABEL REKAP LEBIH LEBAR UNTUK SCROLL */
            #recapTable {
                min-width: 1000px !important;
                width: auto !important;
            }
            
            #recapTable th:nth-child(n+3),
            #recapTable td:nth-child(n+3) {
                width: 22px !important;
                min-width: 22px !important;
                max-width: 22px !important;
                padding: 4px !important;
            }
            
            /* TABEL JURNAL HARI INI LEBIH KECIL DI MOBILE */
            #todayJournalTable {
                font-size: 0.85rem !important;
                min-width: 700px !important;
            }
            
            #todayJournalTable th:nth-child(1),
            #todayJournalTable td:nth-child(1) {
                width: 50px !important;
                min-width: 50px !important;
                max-width: 50px !important;
            }
            
            #todayJournalTable th:nth-child(2),
            #todayJournalTable td:nth-child(2) {
                width: 120px !important;
                min-width: 120px !important;
                max-width: 120px !important;
            }
            
            #todayJournalTable th:nth-child(3),
            #todayJournalTable td:nth-child(3) {
                width: 80px !important;
                min-width: 80px !important;
                max-width: 80px !important;
            }
            
            #todayJournalTable th:nth-child(5),
            #todayJournalTable td:nth-child(5) {
                width: 100px !important;
                min-width: 100px !important;
                max-width: 100px !important;
            }
            
            /* Tanda tangan di mobile - tetap sejajar */
            .signature-section {
                flex-direction: row !important;
                flex-wrap: wrap !important;
                gap: 15px !important;
                margin-top: 20px !important;
                width: 100% !important;
            }
            
            .sig-block {
                flex: 1 0 45% !important;
                min-width: 45% !important;
                margin: 0 !important;
                padding: 0 5px !important;
            }
            
            .profile-stats { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
        }

        @media (max-width: 480px) {
            .content-area { padding: 10px; }
            .card { padding: 15px; }
            .profile-avatar { width: 100px; height: 100px; font-size: 2.5rem; }
            .profile-name { font-size: 1.2rem; }
            .profile-subject { font-size: 0.9rem; }
            .stat-box { padding: 15px; }
            .stat-number { font-size: 1.5rem; }
            
            .signature-section {
                margin-top: 15px !important;
                padding: 8px 0 !important;
                gap: 10px !important;
            }
            
            .sig-block {
                flex: 1 0 45% !important;
                min-width: 45% !important;
            }
            
            .sig-space {
                height: 40px !important;
                margin: 8px 0 !important;
            }
            
            /* TABEL LEBIH KECIL DI HP KECIL */
            #recapTable {
                font-size: 8pt !important;
                min-width: 900px !important;
            }
            
            #recapTable th:nth-child(n+3),
            #recapTable td:nth-child(n+3) {
                width: 20px !important;
                min-width: 20px !important;
                max-width: 20px !important;
                padding: 2px !important;
            }
            
            /* TABEL JURNAL HARI INI LEBIH KECIL */
            #todayJournalTable {
                font-size: 0.8rem !important;
                min-width: 650px !important;
            }
            
            .print-header h2 { font-size: 14pt !important; }
            .print-header h3 { font-size: 11pt !important; }
        }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .empty-state {
            padding: 40px 20px;
            text-align: center;
            color: #64748b;
            background: #f8fafc;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .empty-state-icon { font-size: 3rem; margin-bottom: 15px; opacity: 0.5; }

        .nav-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 10px 15px;
        }

        .photo-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        
        .print-content .signature-section {
            display: flex !important;
        }
        
        .card[style*="border: none"] {
            padding-bottom: 10px !important;
        }
    </style>
</head>
<body>

    <div class="overlay" id="overlay"></div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header"><span>üìö Jurnal Guru</span></div>
        <ul class="nav-links">
            <li class="nav-item"><a class="nav-link active" data-section-id="profil-guru">üë§ Profil Guru</a></li>
            <li class="nav-item"><a class="nav-link" data-section-id="input-profil">‚öôÔ∏è Data Sekolah</a></li>
            <div class="nav-divider"></div>
            <li class="nav-item"><a class="nav-link" data-section-id="input-jurnal">‚úèÔ∏è Input Jurnal</a></li>
            <li class="nav-item"><a class="nav-link" data-section-id="jurnal-hari-ini">üìù Jurnal Hari Ini</a></li>
            <li class="nav-item"><a class="nav-link" data-section-id="rekap-jurnal">üìä Rekap Jurnal</a></li>
            <li class="nav-item"><a class="nav-link" data-section-id="rekap-absen">‚úÖ Rekap Absen</a></li>
            <div class="nav-divider"></div>
            <li class="nav-item"><a class="nav-link" data-section-id="backup-restore">üíæ Backup & Restore</a></li>
        </ul>
    </aside>

    <main class="main-content">
        <header class="top-bar">
            <button class="menu-toggle" id="menuToggle">‚ò∞</button>
            <div class="page-title" id="pageTitle">Profil Guru</div>
            <div style="font-size: 0.8rem; color: #64748b;" id="currentDateDisplay"></div>
        </header>

        <div class="content-area" id="mainContentArea">
            
            <!-- SECTION: PROFIL GURU -->
            <section id="profil-guru" class="section active">
                <div class="card">
                    <div class="card-header">
                        <span>Profil Guru</span>
                        <button class="btn btn-primary" id="editProfileBtn">‚úèÔ∏è Edit Profil</button>
                    </div>
                    
                    <!-- View Mode -->
                    <div id="profileViewMode" class="profile-card">
                        <div class="profile-avatar" id="profileAvatarDisplay">
                            <img id="profileAvatarImg" src="" alt="Foto Profil" style="display: none;">
                            <span id="profileAvatarInitials">üë§</span>
                        </div>
                        <div class="profile-name" id="profileNameDisplay">Nama Guru</div>
                        <div class="profile-subject" id="profileSubjectDisplay">Mata Pelajaran</div>
                        
                        <div class="profile-info">
                            <div class="profile-info-item">
                                <div class="profile-info-label">Sekolah</div>
                                <div class="profile-info-value" id="profileSchoolDisplay">-</div>
                            </div>
                            <div class="profile-info-item">
                                <div class="profile-info-label">Kelas Diajar</div>
                                <div class="profile-info-value" id="profileClassDisplay">-</div>
                            </div>
                        </div>

                        <div class="profile-stats">
                            <div class="stat-box">
                                <div class="stat-number" id="statTotalJurnal">0</div>
                                <div class="stat-label">Total Jurnal</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number" id="statTotalKelas">3</div>
                                <div class="stat-label">Kelas Diajar</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number" id="statTotalSiswa">0</div>
                                <div class="stat-label">Total Siswa</div>
                            </div>
                        </div>
                    </div>

                    <!-- Edit Mode -->
                    <div id="profileEditMode" style="display: none;">
                        <form id="teacherProfileForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="teacherFullName">Nama Lengkap</label>
                                    <input type="text" id="teacherFullName" placeholder="Nama lengkap dengan gelar" required>
                                </div>
                                <div class="form-group">
                                    <label for="teacherSubject">Mata Pelajaran</label>
                                    <input type="text" id="teacherSubject" placeholder="Mata pelajaran yang diampu" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="teacherClass">Kelas yang Diajar</label>
                                    <select id="teacherClass" multiple style="height: 120px;">
                                        <option value="X">Kelas X</option>
                                        <option value="XI">Kelas XI</option>
                                        <option value="XII">Kelas XII</option>
                                    </select>
                                    <small style="color: #64748b;">Tahan Ctrl untuk memilih banyak kelas</small>
                                </div>
                            </div>
                            <div class="btn-group" style="margin-top: 20px;">
                                <button type="submit" class="btn btn-primary">üíæ Simpan Profil</button>
                                <button type="button" class="btn btn-danger" id="cancelEditProfileBtn">Batal</button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- SECTION: DATA SEKOLAH -->
            <section id="input-profil" class="section">
                <div class="card">
                    <div class="card-header">Identitas Sekolah & Foto Profil</div>
                    
                    <!-- Foto Profil Section -->
                    <div class="photo-upload-area" id="photoUploadArea">
                        <div id="photoUploadText">
                            <div style="font-size: 3rem; color: var(--primary); margin-bottom: 15px;">üì∑</div>
                            <h3>Unggah Foto Profil</h3>
                            <p style="color: #64748b; font-size: 0.9rem;">Klik untuk memilih foto (JPG/PNG, maks. 2MB)</p>
                        </div>
                        <img id="photoPreview" class="photo-preview" alt="Preview Foto">
                    </div>
                    <input type="file" id="photoInput" accept="image/*" style="display: none;">
                    
                    <div class="photo-controls" id="photoControls" style="display: none;">
                        <button class="btn btn-primary" id="savePhotoBtn">Simpan Foto</button>
                        <button class="btn btn-danger" id="removePhotoBtn">Hapus Foto</button>
                    </div>
                    
                    <form id="profileForm" style="margin-top: 20px;">
                        <div class="form-group">
                            <label for="schoolName">Nama Sekolah</label>
                            <input type="text" id="schoolName" placeholder="SMK Negeri..." required>
                        </div>
                        <div class="form-group">
                            <label for="schoolCity">Kota / Kabupaten</label>
                            <input type="text" id="schoolCity" placeholder="Contoh: Surabaya" required>
                        </div>
                        <div class="form-group">
                            <label for="principalName">Nama Kepala Sekolah</label>
                            <input type="text" id="principalName" placeholder="Nama Kepala Sekolah" required>
                        </div>
                        <div class="form-group">
                            <label for="principalNIP">NIP Kepala Sekolah</label>
                            <input type="text" id="principalNIP" placeholder="NIP Kepala Sekolah">
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">üíæ Simpan Data Sekolah</button>
                            <button type="button" class="btn btn-success" id="autoFillSampleDataBtn">üìã Contoh Data</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- SECTION: INPUT JURNAL -->
            <section id="input-jurnal" class="section">
                <div class="card">
                    <div class="card-header">Catat Kegiatan Hari Ini</div>
                    <form id="journalForm">
                        <div class="form-group">
                            <label for="journalDate">Tanggal</label>
                            <input type="date" id="journalDate" required>
                        </div>
                        <div class="form-group">
                            <label for="journalClass">Kelas</label>
                            <select id="journalClass" required>
                                <option value="">-- Pilih Kelas --</option>
                                <option value="X">Kelas X</option>
                                <option value="XI">Kelas XI</option>
                                <option value="XII">Kelas XII</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="journalKD">Kompetensi Dasar / Materi</label>
                            <textarea id="journalKD" rows="3" placeholder="Topik pembelajaran..." required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="studentSearch">Siswa Tidak Hadir</label>
                            <div class="search-container">
                                <input type="text" id="studentSearch" class="search-input" placeholder="Ketik nama siswa..." autocomplete="off" disabled>
                                <div id="suggestions" class="suggestions" style="display:none;"></div>
                            </div>
                            <div id="selectedTags" class="tags-container"></div>
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">Simpan Jurnal</button>
                            <button type="button" class="btn btn-danger" id="clearJournalFormBtn">Reset Form</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- SECTION: JURNAL HARI INI (BARU) - FORMAT TABEL -->
            <section id="jurnal-hari-ini" class="section">
                <div class="card today-journal-card">
                    <div class="today-journal-header">
                        <span style="font-size: 1.2rem; font-weight: 700;">üìù Jurnal Hari Ini</span>
                        <div class="today-date-badge" id="todayDateBadge"></div>
                    </div>
                    
                    <div id="todayJournalContent">
                        <!-- Tabel jurnal hari ini akan diisi oleh JavaScript -->
                        <div class="table-responsive">
                            <table id="todayJournalTable">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">No</th>
                                        <th style="width: 150px;">Hari, Tanggal, Bulan, Tahun</th>
                                        <th style="width: 80px;">Kelas</th>
                                        <th>Materi / Kegiatan</th>
                                        <th style="width: 100px;">Absen</th>
                                        <th class="no-print" style="width: 70px;">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="todayJournalTbody">
                                    <!-- Data akan diisi oleh JavaScript -->
                                </tbody>
                            </table>
                            <div id="todayJournalEmpty" class="today-empty-state" style="display: none;">
                                <div class="today-empty-state-icon">üìù</div>
                                <h3>Belum ada jurnal untuk hari ini</h3>
                                <p>Mulai dengan mengisi jurnal mengajar di menu "Input Jurnal"</p>
                                <button class="btn btn-primary" id="gotoInputJournalBtn" style="margin-top: 15px;">
                                    ‚úèÔ∏è Isi Jurnal Hari Ini
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECTION: REKAP JURNAL (DULU CETAK JURNAL) -->
            <section id="rekap-jurnal" class="section">
                <div id="capture-jurnal" class="print-content pdf-optimized">
                    <div class="print-header">
                        <h2 id="printSchoolName">Nama Sekolah</h2>
                        <p>Guru: <span id="printTeacherName">-</span> | Mapel: <span id="printSubject">-</span></p>
                        <h3>LAPORAN JURNAL MENGAJAR</h3>
                        <p style="margin-top: 5px; font-size: 10pt;">Tanggal Cetak: <span id="printDate1"></span></p>
                    </div>

                    <div class="card" style="border: none; box-shadow: none; padding-bottom: 10px;">
                        <div class="card-header no-print" style="border-bottom: none;">
                            <span>Riwayat Jurnal</span>
                            <div class="filter-group no-print">
                                <select id="printClassFilter" class="yellow-select">
                                    <option value="ALL">üè´ Semua Kelas</option>
                                    <option value="X">üìò Kelas X</option>
                                    <option value="XI">üìó Kelas XI</option>
                                    <option value="XII">üìï Kelas XII</option>
                                </select>
                                <div class="btn-group">
                                    <button class="btn btn-pdf" id="downloadJurnalPdfBtn">üìÑ Download PDF</button>
                                    <button class="btn btn-print" id="printJurnalBtn">üñ®Ô∏è Print</button>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table id="historyTable">
                                <thead>
                                    <tr>
                                        <th style="width: 15%;">Tanggal</th>
                                        <th style="width: 10%;">Kelas</th>
                                        <th>Materi / Kegiatan</th>
                                        <th style="width: 25%;">Absensi</th>
                                        <th class="no-print" style="width: 70px;">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                            <div id="historyEmpty" class="empty-state" style="display: none;">
                                <div class="empty-state-icon">üìù</div>
                                <h3>Belum ada data jurnal</h3>
                                <p>Mulai dengan mengisi jurnal mengajar di menu "Input Jurnal"</p>
                            </div>
                        </div>

                        <div class="signature-section">
                            <div class="sig-block">
                                <p>Mengetahui,</p>
                                <p>Kepala Sekolah</p>
                                <div class="sig-space"></div>
                                <p><b id="sigPrincipal1">Nama Kepala Sekolah</b></p>
                                <p>NIP. <span id="sigPrincipalNIP1">  </span></p>
                            </div>
                            <div class="sig-block">
                                <p id="sigDate1">Kota, Tanggal</p>
                                <p>Guru Mata Pelajaran</p>
                                <div class="sig-space"></div>
                                <p><b id="sigTeacher1">Nama Guru</b></p>
                                <p>NIP. <span id="sigTeacherNIP1">  </span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECTION: REKAP ABSEN -->
            <section id="rekap-absen" class="section">
                <div id="capture-rekap" class="print-content pdf-optimized">
                    <div class="print-header">
                        <h2 id="rekapSchoolNameHeader">Nama Sekolah</h2>
                        <h3>REKAPITULASI ABSENSI SISWA BULAN <span id="rekapMonthName"></span> TAHUN <span id="rekapYearPrint"></span></h3>
                        <p style="margin-top: 5px; font-size: 10pt;">Tanggal Cetak: <span id="printDate2"></span></p>
                    </div>

                    <div class="card" style="border: none; box-shadow: none; padding-bottom: 10px;">
                        <div class="card-header no-print" style="border-bottom: none;">
                            <span>Rekapitulasi</span>
                            <div class="filter-group no-print">
                                <select id="recapMonthFilter" class="yellow-select month-year-filter"></select>
                                <select id="recapYearFilter" class="yellow-select month-year-filter"></select>
                                <select id="recapClassFilter" class="yellow-select">
                                    <option value="ALL">üè´ Semua Kelas</option>
                                    <option value="X">üìò Kelas X</option>
                                    <option value="XI">üìó Kelas XI</option>
                                    <option value="XII">üìï Kelas XII</option>
                                </select>
                                <div class="btn-group">
                                    <button class="btn btn-pdf" id="downloadRekapPdfBtn">üìÑ Download PDF</button>
                                    <button class="btn btn-print" id="printRekapBtn">üñ®Ô∏è Print</button>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table id="recapTable">
                                <thead></thead>
                                <tbody id="recapBody"></tbody>
                                <tfoot id="recapFoot"></tfoot>
                            </table>
                            <div id="recapEmpty" class="empty-state" style="display: none;">
                                <div class="empty-state-icon">‚úÖ</div>
                                <h3>Tidak ada data absensi</h3>
                                <p>Pastikan Anda telah mengisi jurnal untuk bulan dan kelas yang dipilih.</p>
                            </div>
                        </div>

                        <div class="signature-section">
                            <div class="sig-block">
                                <p>Mengetahui,</p>
                                <p>Kepala Sekolah</p>
                                <div class="sig-space"></div>
                                <p><b id="sigPrincipal2">Nama Kepala Sekolah</b></p>
                                <p>NIP. <span id="sigPrincipalNIP2">  </span></p>
                            </div>
                            <div class="sig-block">
                                <p id="sigDate2">Kota, Tanggal</p>
                                <p>Guru Mata Pelajaran</p>
                                <div class="sig-space"></div>
                                <p><b id="sigTeacher2">Nama Guru</b></p>
                                <p>NIP. <span id="sigTeacherNIP2">  </span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECTION: BACKUP & RESTORE -->
            <section id="backup-restore" class="section">
                <div class="card">
                    <div class="card-header">Backup & Restore Data</div>
                    <div class="backup-area">
                        <div>
                            <h3>üíæ Backup Data</h3>
                            <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 10px;">
                                Download semua data ke file .json
                            </p>
                            <div class="btn-group">
                                <button class="btn btn-primary" id="exportBackupBtn">Download Backup</button>
                                <button class="btn btn-danger" id="confirmClearDataBtn">Hapus Semua Data</button>
                            </div>
                        </div>
                        <hr style="border: 0; border-top: 1px solid #ddd;">
                        <div>
                            <h3>üìÇ Restore Data</h3>
                            <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 10px;">
                                Upload file .json untuk mengembalikan data
                            </p>
                            <input type="file" id="fileInput" accept=".json" style="display:none">
                            <button class="btn btn-success" id="selectFileBtn">Pilih File Backup</button>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <div id="toast">Pesan</div>
    <div id="pdfLoading" class="pdf-loading">
        <div class="spinner"></div>
        <div style="font-weight: bold; font-size: 1.2rem;">Sedang Membuat PDF...</div>
        <small>Mohon tunggu sebentar</small>
    </div>

    <script>
        // --- DATA SISWA ---
        let students = [
            { nis: '0094789075', nama: 'ADI SAPUTRA', kelas: 'X (Sepuluh)' },
            { nis: '0096019190', nama: 'AULIA NUR LAELA', kelas: 'X (Sepuluh)' },
            { nis: '0107301719', nama: 'CIPA NADIA SALMA', kelas: 'X (Sepuluh)' },
            { nis: '0088133836', nama: 'DEDI IRAWAN', kelas: 'X (Sepuluh)' },
            { nis: '0097790486', nama: 'FAREL SAPUTERA', kelas: 'X (Sepuluh)' },
            { nis: '0106097706', nama: 'ISMAWATI DWI ANGGRAINI', kelas: 'X (Sepuluh)' },
            { nis: '0085852231', nama: 'IRFAN', kelas: 'X (Sepuluh)' },
            { nis: '0092200897', nama: 'LUTHFI HAKIM', kelas: 'X (Sepuluh)' },
            { nis: '0109081925', nama: 'M.ADITYA PRAYOGA', kelas: 'X (Sepuluh)' },
            { nis: '0094433103', nama: 'M.AL IMRON', kelas: 'X (Sepuluh)' },
            { nis: '0097848607', nama: 'MOHAMAT HARIS SETIAWAN', kelas: 'X (Sepuluh)' },
            { nis: '0082735425', nama: 'MOHAMAD RIKI SAPUTRA', kelas: 'X (Sepuluh)' },
            { nis: '0102522253', nama: 'RADITYA DANU PRATAMA', kelas: 'X (Sepuluh)' },
            { nis: '0102235604', nama: 'RIDHO FIRMANSYAH', kelas: 'X (Sepuluh)' },
            { nis: '0099798429', nama: 'RIZKI CAHYO SUGENG WIBOWO', kelas: 'X (Sepuluh)' },
            { nis: '0000000316', nama: 'RIZAL ABDUL HAQ', kelas: 'X (Sepuluh)' },
            { nis: '0106667835', nama: 'SAFA AULIA PUTRI', kelas: 'X (Sepuluh)' },
            { nis: '0105199297', nama: 'SHINTA SASTYA WATI', kelas: 'X (Sepuluh)' },
            { nis: '3106050813', nama: 'TIYAS FARIDA SARI', kelas: 'X (Sepuluh)' },
            { nis: '0095977397', nama: 'FAIS DAROIN', kelas: 'X (Sepuluh)' },
            { nis: '0095046784', nama: 'YULIA MUSLIMATUS SADIYAH', kelas: 'X (Sepuluh)' },
            { nis: '0084903816', nama: 'Ahmad Iqbal', kelas: 'XI (Sebelas)' },
            { nis: '0088606301', nama: 'Ahmad Ramadhani', kelas: 'XI (Sebelas)' },
            { nis: '1000000001', nama: 'Argi Setiawan', kelas: 'XI (Sebelas)' },
            { nis: '0081098360', nama: 'Aisyah Lu\'lu\'ul Husna', kelas: 'XI (Sebelas)' },
            { nis: '0095627591', nama: 'Anggun Puspita Anggraini', kelas: 'XI (Sebelas)' },
            { nis: '0089314202', nama: 'Dafa', kelas: 'XI (Sebelas)' },
            { nis: '0091007309', nama: 'Devita Anjani', kelas: 'XI (Sebelas)' },
            { nis: '2000000002', nama: 'Ferdi Kurniawan', kelas: 'XI (Sebelas)' },
            { nis: '3000000003', nama: 'Fitra Afriza', kelas: 'XI (Sebelas)' },
            { nis: '0084423897', nama: 'Indah Kasturi Kusuma Putri', kelas: 'XI (Sebelas)' },
            { nis: '0098669866', nama: 'Lefiyana Juwita', kelas: 'XI (Sebelas)' },
            { nis: '0085606025', nama: 'Marchfel Firdiyansah', kelas: 'XI (Sebelas)' },
            { nis: '0089725108', nama: 'Melinda Kusuma Dewi', kelas: 'XI (Sebelas)' },
            { nis: '0092585298', nama: 'M.Yudha Rizki Iftori', kelas: 'XI (Sebelas)' },
            { nis: '0074048074', nama: 'Mohamad Ibnu Rosid', kelas: 'XI (Sebelas)' },
            { nis: '0083168310', nama: 'M.Bisma Mega Nanda', kelas: 'XI (Sebelas)' },
            { nis: '0095212808', nama: 'M.Rizki Ramadhani', kelas: 'XI (Sebelas)' },
            { nis: '0000000004', nama: 'M.Fiki Darmawan', kelas: 'XI (Sebelas)' },
            { nis: '3095650322', nama: 'M.Badru Muwafaq', kelas: 'XI (Sebelas)' },
            { nis: '0095475420', nama: 'Rima', kelas: 'XI (Sebelas)' },
            { nis: '0095395423', nama: 'Rima Ulvania', kelas: 'XI (Sebelas)' },
            { nis: '0091673355', nama: 'Riski Munandar', kelas: 'XI (Sebelas)' },
            { nis: '0064036686', nama: 'Siti Miftakhul Makmuroh', kelas: 'XI (Sebelas)' },
            { nis: '0091403540', nama: 'Tomi Jadmiko', kelas: 'XI (Sebelas)' },
            { nis: '0086855084', nama: 'Tia Dwi Saputri', kelas: 'XI (Sebelas)' },
            { nis: '0000000005', nama: 'Wafiq Khariri', kelas: 'XI (Sebelas)' },
            { nis: '0095475421', nama: 'Yeni Winarni', kelas: 'XI (Sebelas)' },
            { nis: '0000000006', nama: 'Ainun Nadhiroh', kelas: 'XI (Sebelas)' },
            { nis: '0098781514', nama: 'Habibatus Zakia', kelas: 'XI (Sebelas)' },
            { nis: '3096763981', nama: 'Dwi Fatimah', kelas: 'XI (Sebelas)' },
            { nis: '3085136071', nama: 'M.Akbar Panjalu', kelas: 'XI (Sebelas)' },
            { nis: '0000000007', nama: 'Angga Dwi Saputra', kelas: 'XI (Sebelas)' },
            { nis: '0077667204', nama: 'Ahmad Maulana', kelas: 'XII (dua Belas)' },
            { nis: '0085214724', nama: 'Aliya Ayu Marlina', kelas: 'XII (dua Belas)' },
            { nis: '0087149069', nama: 'Aprilia Winanti', kelas: 'XII (dua Belas)' },
            { nis: '0082699089', nama: 'Bagas Setiawan', kelas: 'XII (dua Belas)' },
            { nis: '0068818482', nama: 'Bagus Akbar Rani', kelas: 'XII (dua Belas)' },
            { nis: '0088041522', nama: 'Binti Lutfiyah Zakiyah', kelas: 'XII (dua Belas)' },
            { nis: '0087100213', nama: 'Cantika Dwi Jayanti', kelas: 'XII (dua Belas)' },
            { nis: '0073724648', nama: 'Dennis Prasetiyo', kelas: 'XII (dua Belas)' },
            { nis: '0073965350', nama: 'Disky Ramadani', kelas: 'XII (dua Belas)' },
            { nis: '0072676706', nama: 'Ega Saputra', kelas: 'XII (dua Belas)' },
            { nis: '0085103057', nama: 'Eka Putri Febriani', kelas: 'XII (dua Belas)' },
            { nis: '0083708627', nama: 'Endra Saputra', kelas: 'XII (dua Belas)' },
            { nis: '0081159769', nama: 'Farid Ahmad Faisal', kelas: 'XII (dua Belas)' },
            { nis: '0084757704', nama: 'Maulana Dava', kelas: 'XII (dua Belas)' },
            { nis: '0000000008', nama: 'Maya Safitri', kelas: 'XII (dua Belas)' },
            { nis: '0077167251', nama: 'Miranti', kelas: 'XII (dua Belas)' },
            { nis: '0072775329', nama: 'Muhammad Aldino Ama Rasya', kelas: 'XII (dua Belas)' },
            { nis: '0082727230', nama: 'Muhammad Ahya', kelas: 'XII (dua Belas)' },
            { nis: '0081846871', nama: 'Mohamad Dendi Firmanto', kelas: 'XII (dua Belas)' },
            { nis: '0084244287', nama: 'Muhamad Misbahul Munir', kelas: 'XII (dua Belas)' },
            { nis: '0089726548', nama: 'Muhammad Rejaki', kelas: 'XII (dua Belas)' },
            { nis: '0077347477', nama: 'Mohammad Sulton Al-azhar', kelas: 'XII (dua Belas)' },
            { nis: '0085214725', nama: 'Nanda Ayu Ningsih', kelas: 'XII (dua Belas)' },
            { nis: '0000000012', nama: 'Nayla Amin', kelas: 'XII (dua Belas)' },
            { nis: '0071174694', nama: 'Rahma Wulandari', kelas: 'XII (dua Belas)' },
            { nis: '0084479963', nama: 'Rendi Hidayat', kelas: 'XII (dua Belas)' },
            { nis: '0088343077', nama: 'Sahal Wahyudin', kelas: 'XII (dua Belas)' },
            { nis: '0000000009', nama: 'Shera Aurelia Sariana', kelas: 'XII (dua Belas)' },
            { nis: '0070226573', nama: 'Sulamanul Jamal', kelas: 'XII (dua Belas)' },
            { nis: '0075282696', nama: 'Tiara Saputri', kelas: 'XII (dua Belas)' },
            { nis: '0084034253', nama: 'Wahyuni Naila Ngilma', kelas: 'XII (dua Belas)' },
            { nis: '0087602782', nama: 'Laura Meliyana Dewi', kelas: 'XII (dua Belas)' },
            { nis: '0000000010', nama: 'EKO NUZULUL MISBAH', kelas: 'XII (dua Belas)' },
        ];

        let studentDatabase = { 'X': [], 'XI': [], 'XII': [] };
        let studentNISMap = {};
        let selectedStudents = [];
        let journalHistory = [];
        let teacherProfile = {};
        let schoolProfile = {};
        let currentPhotoData = null;
        let lastCheckedDate = ''; // Untuk mengecek perubahan tanggal
        
        const monthNames = [
            'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
            'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
        ];

        const dayNames = [
            'Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'
        ];

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('journalDate').value = today;
            
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateDisplay = new Date().toLocaleDateString('id-ID', options);
            document.getElementById('currentDateDisplay').textContent = dateDisplay;
            
            // Set badge tanggal hari ini
            document.getElementById('todayDateBadge').textContent = dateDisplay;
            
            // Set tanggal terakhir dicek
            lastCheckedDate = today;
            
            initializeApp();
            addEventListeners();
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-container')) {
                    document.getElementById('suggestions').style.display = 'none';
                }
            });
            
            // Cek perubahan tanggal setiap menit
            setInterval(checkDateChange, 60000); // Cek setiap 1 menit
        });

        function initializeApp() {
            // Load semua data
            loadAllData();
            
            // Group siswa
            groupStudents();
            
            // Load history jurnal
            loadHistory();
            
            // Update tampilan
            updateProfileDisplay();
            
            // Populate filter rekap
            populateRecapFilters();
            
            // Load foto profil jika ada
            loadProfilePhoto();
            
            // Update tanggal cetak
            updatePrintDates();
            
            // Tampilkan jurnal hari ini
            displayTodayJournal();
        }

        function loadAllData() {
            // Load teacher profile
            teacherProfile = JSON.parse(localStorage.getItem('teacherProfile') || '{}');
            
            // Load school profile
            schoolProfile = JSON.parse(localStorage.getItem('schoolProfile') || '{}');
            
            // Load last checked date
            const savedLastDate = localStorage.getItem('lastCheckedDate');
            if (savedLastDate) {
                lastCheckedDate = savedLastDate;
            }
            
            // Isi form jika ada data
            if(schoolProfile) {
                document.getElementById('schoolName').value = schoolProfile.school || '';
                document.getElementById('schoolCity').value = schoolProfile.city || '';
                document.getElementById('principalName').value = schoolProfile.principal || '';
                document.getElementById('principalNIP').value = schoolProfile.principalNIP || '';
            }
        }

        function loadProfilePhoto() {
            const photoData = localStorage.getItem('teacherPhoto');
            if (photoData) {
                currentPhotoData = photoData;
                const photoPreview = document.getElementById('photoPreview');
                const photoUploadText = document.getElementById('photoUploadText');
                const photoControls = document.getElementById('photoControls');
                const profileAvatarImg = document.getElementById('profileAvatarImg');
                const profileAvatarInitials = document.getElementById('profileAvatarInitials');
                
                photoPreview.src = photoData;
                photoPreview.style.display = 'block';
                photoUploadText.style.display = 'none';
                photoControls.style.display = 'flex';
                
                profileAvatarImg.src = photoData;
                profileAvatarImg.style.display = 'block';
                profileAvatarInitials.style.display = 'none';
            }
        }

        function updatePrintDates() {
            const today = new Date();
            const formattedDate = today.toLocaleDateString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('printDate1').textContent = formattedDate;
            document.getElementById('printDate2').textContent = formattedDate;
        }

        function addEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function() {
                    showSection(this.dataset.sectionId, this);
                });
            });

            document.getElementById('menuToggle').addEventListener('click', toggleSidebar);
            document.getElementById('overlay').addEventListener('click', toggleSidebar);

            // Profile Guru Events
            document.getElementById('editProfileBtn').addEventListener('click', toggleProfileEdit);
            document.getElementById('cancelEditProfileBtn').addEventListener('click', toggleProfileEdit);
            document.getElementById('teacherProfileForm').addEventListener('submit', (e) => {
                e.preventDefault();
                saveTeacherProfile();
            });

            // School Profile & Photo
            document.getElementById('profileForm').addEventListener('submit', (e) => {
                e.preventDefault();
                saveSchoolProfile();
            });
            document.getElementById('autoFillSampleDataBtn').addEventListener('click', autoFillSampleData);
            
            // Photo Upload
            document.getElementById('photoUploadArea').addEventListener('click', () => {
                document.getElementById('photoInput').click();
            });
            document.getElementById('photoInput').addEventListener('change', handlePhotoUpload);
            document.getElementById('savePhotoBtn').addEventListener('click', saveProfilePhoto);
            document.getElementById('removePhotoBtn').addEventListener('click', removeProfilePhoto);

            // Journal Form
            document.getElementById('journalClass').addEventListener('change', handleClassChange);
            document.getElementById('studentSearch').addEventListener('input', (e) => {
                const query = e.target.value;
                const cls = document.getElementById('journalClass').value;
                displaySuggestions(query, cls);
            });
            document.getElementById('journalForm').addEventListener('submit', (e) => {
                e.preventDefault();
                saveJournalEntry();
            });
            document.getElementById('clearJournalFormBtn').addEventListener('click', clearJournalForm);

            // Print/PDF Events
            document.getElementById('printClassFilter').addEventListener('change', renderHistoryTable);
            document.getElementById('downloadJurnalPdfBtn').addEventListener('click', () => generatePDF('jurnal'));
            document.getElementById('printJurnalBtn').addEventListener('click', () => printSection('jurnal'));

            document.getElementById('recapMonthFilter').addEventListener('change', renderRecapTable);
            document.getElementById('recapYearFilter').addEventListener('change', renderRecapTable);
            document.getElementById('recapClassFilter').addEventListener('change', renderRecapTable);
            document.getElementById('downloadRekapPdfBtn').addEventListener('click', () => generatePDF('rekap'));
            document.getElementById('printRekapBtn').addEventListener('click', () => printSection('rekap'));

            // Backup/Restore Events
            document.getElementById('exportBackupBtn').addEventListener('click', exportBackup);
            document.getElementById('confirmClearDataBtn').addEventListener('click', confirmClearData);
            document.getElementById('selectFileBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('fileInput').addEventListener('change', function() {
                importBackup(this);
            });
            
            // Tombol goto input jurnal
            document.addEventListener('click', function(e) {
                if (e.target && e.target.id === 'gotoInputJournalBtn') {
                    const inputLink = document.querySelector('.nav-link[data-section-id="input-jurnal"]');
                    if (inputLink) showSection('input-jurnal', inputLink);
                }
            });
        }

        // --- FUNGSI JURNAL HARI INI ---

        function checkDateChange() {
            const today = new Date().toISOString().split('T')[0];
            
            if (today !== lastCheckedDate) {
                // Tanggal berubah, update tampilan
                lastCheckedDate = today;
                localStorage.setItem('lastCheckedDate', today);
                
                // Update date display
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const dateDisplay = new Date().toLocaleDateString('id-ID', options);
                document.getElementById('currentDateDisplay').textContent = dateDisplay;
                document.getElementById('todayDateBadge').textContent = dateDisplay;
                
                // Update form tanggal
                document.getElementById('journalDate').value = today;
                
                // Update tampilan jurnal hari ini
                displayTodayJournal();
                
                // Tampilkan notifikasi jika sedang di menu Jurnal Hari Ini
                if (document.getElementById('jurnal-hari-ini').classList.contains('active')) {
                    showToast("Hari baru! Jurnal hari ini telah diperbarui.", 'info');
                }
            }
        }

        function formatDateLong(dateStr) {
            const d = new Date(dateStr + 'T00:00:00');
            const dayName = dayNames[d.getDay()];
            const day = d.getDate();
            const month = monthNames[d.getMonth()];
            const year = d.getFullYear();
            
            return `${dayName}, ${day} ${month} ${year}`;
        }

        function displayTodayJournal() {
            const today = new Date().toISOString().split('T')[0];
            const todayJournals = journalHistory.filter(journal => journal.date === today);
            const tbody = document.getElementById('todayJournalTbody');
            const emptyState = document.getElementById('todayJournalEmpty');
            
            tbody.innerHTML = '';

            if (todayJournals.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            todayJournals.forEach((journal, index) => {
                const formattedDate = formatDateLong(journal.date);
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${formattedDate}</td>
                    <td><strong>${journal.class}</strong></td>
                    <td>${journal.kd}</td>
                    <td>
                        ${journal.absent.length > 0 
                            ? `<div class="absent-list">
                                ${journal.absent.map(student => `<span>${student}</span>`).join('')}
                               </div>
                               <small style="color: var(--danger); font-weight: 600;">${journal.absent.length} siswa</small>`
                            : '<span class="all-present">‚úì Hadir Semua</span>'
                        }
                    </td>
                    <td class="no-print">
                        <button class="btn btn-danger" style="padding:4px 8px; font-size:0.7rem;" data-journal-id="${journal.id}">Hapus</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Tambahkan event listener untuk tombol hapus
            tbody.querySelectorAll('.btn-danger[data-journal-id]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const journalId = parseInt(e.target.dataset.journalId);
                    deleteTodayJournal(journalId);
                });
            });
        }

        function deleteTodayJournal(id) {
            if(confirm('Hapus jurnal hari ini?')) {
                journalHistory = journalHistory.filter(j => j.id !== id);
                localStorage.setItem('journals', JSON.stringify(journalHistory));
                updateProfileDisplay();
                displayTodayJournal();
                renderHistoryTable();
                renderRecapTable();
                showToast("Jurnal hari ini berhasil dihapus", 'warning');
            }
        }

        function groupStudents() {
            studentDatabase = { 'X': [], 'XI': [], 'XII': [] };
            studentNISMap = {};

            students.forEach(s => {
                let className = '';
                if (s.kelas.includes('Sepuluh') || s.kelas === 'X') {
                    className = 'X';
                } else if (s.kelas.includes('Sebelas') || s.kelas === 'XI') {
                    className = 'XI';
                } else if (s.kelas.includes('Belas') || s.kelas === 'XII') {
                    className = 'XII';
                }
                
                s.className = className;
                
                if (studentDatabase[className]) {
                    studentDatabase[className].push(s);
                    studentNISMap[s.nama] = s.nis;
                }
            });
            
            for (const cls in studentDatabase) {
                studentDatabase[cls].sort((a, b) => a.nama.localeCompare(b.nama));
            }
        }

        function showSection(sectionId, navElement) {
            // Sembunyikan semua section
            document.querySelectorAll('.section').forEach(sec => {
                sec.classList.remove('active');
                sec.style.overflow = 'visible';
            });
            
            // Tampilkan section yang dipilih
            document.getElementById(sectionId).classList.add('active');
            
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            navElement.classList.add('active');
            document.getElementById('pageTitle').textContent = navElement.innerText.replace(/[^\w\s&]/g, '').trim();

            if(window.innerWidth <= 768) toggleSidebar();
            
            if(sectionId === 'profil-guru') updateProfileDisplay();
            if(sectionId === 'jurnal-hari-ini') {
                displayTodayJournal();
                // PERBAIKAN: Reset scroll ke atas
                document.getElementById('mainContentArea').scrollTop = 0;
            }
            if(sectionId === 'rekap-jurnal') {
                renderHistoryTable();
                updatePrintDates();
                
                // PERBAIKAN: Reset scroll ke atas
                document.getElementById('mainContentArea').scrollTop = 0;
            }
            if(sectionId === 'rekap-absen') {
                document.getElementById('rekapSchoolNameHeader').textContent = document.getElementById('schoolName').value || 'Nama Sekolah';
                renderRecapTable();
                updatePrintDates();
                
                // PERBAIKAN: Reset scroll ke atas
                document.getElementById('mainContentArea').scrollTop = 0;
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('active');
        }

        function toggleProfileEdit() {
            const viewMode = document.getElementById('profileViewMode');
            const editMode = document.getElementById('profileEditMode');
            const editBtn = document.getElementById('editProfileBtn');
            
            if (viewMode.style.display !== 'none') {
                viewMode.style.display = 'none';
                editMode.style.display = 'block';
                editBtn.style.display = 'none';
                
                // Load existing data into form
                document.getElementById('teacherFullName').value = teacherProfile.name || '';
                document.getElementById('teacherSubject').value = teacherProfile.subject || '';
                
                // Set selected classes
                const classSelect = document.getElementById('teacherClass');
                if (teacherProfile.classes) {
                    const classesArray = teacherProfile.classes.split(',');
                    for (let i = 0; i < classSelect.options.length; i++) {
                        classSelect.options[i].selected = classesArray.includes(classSelect.options[i].value);
                    }
                }
            } else {
                viewMode.style.display = 'block';
                editMode.style.display = 'none';
                editBtn.style.display = 'inline-flex';
            }
        }

        function saveTeacherProfile() {
            const selectedClasses = Array.from(document.getElementById('teacherClass').selectedOptions)
                .map(opt => opt.value)
                .join(',');
            
            teacherProfile = {
                name: document.getElementById('teacherFullName').value,
                subject: document.getElementById('teacherSubject').value,
                classes: selectedClasses
            };
            
            localStorage.setItem('teacherProfile', JSON.stringify(teacherProfile));
            updateProfileDisplay();
            toggleProfileEdit();
            showToast("Profil Guru Berhasil Disimpan!", 'success');
        }

        function updateProfileDisplay() {
            // Update profile card display
            document.getElementById('profileNameDisplay').textContent = teacherProfile.name || 'Nama Guru';
            document.getElementById('profileSubjectDisplay').textContent = teacherProfile.subject || 'Mata Pelajaran';
            document.getElementById('profileSchoolDisplay').textContent = schoolProfile.school || '-';
            
            // Update kelas diajar
            const classesArray = teacherProfile.classes ? teacherProfile.classes.split(',') : [];
            document.getElementById('profileClassDisplay').textContent = classesArray.map(c => `Kelas ${c}`).join(', ') || '-';
            
            // Update avatar with initials or photo
            const name = teacherProfile.name || '';
            if (currentPhotoData) {
                document.getElementById('profileAvatarImg').style.display = 'block';
                document.getElementById('profileAvatarInitials').style.display = 'none';
            } else {
                const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() || 'üë§';
                document.getElementById('profileAvatarImg').style.display = 'none';
                document.getElementById('profileAvatarInitials').style.display = 'block';
                document.getElementById('profileAvatarInitials').textContent = initials.length > 0 && name ? initials : 'üë§';
            }
            
            // Update statistics
            document.getElementById('statTotalJurnal').textContent = journalHistory.length;
            document.getElementById('statTotalSiswa').textContent = students.length;
            
            // Update print headers
            document.getElementById('printTeacherName').textContent = teacherProfile.name || '-';
            document.getElementById('printSubject').textContent = teacherProfile.subject || '-';
            document.getElementById('printSchoolName').textContent = schoolProfile.school || 'Nama Sekolah';
            
            // Update signature sections
            document.getElementById('sigTeacher1').textContent = teacherProfile.name || 'Nama Guru';
            document.getElementById('sigTeacher2').textContent = teacherProfile.name || 'Nama Guru';
            document.getElementById('sigPrincipal1').textContent = schoolProfile.principal || 'Nama Kepala Sekolah';
            document.getElementById('sigPrincipal2').textContent = schoolProfile.principal || 'Nama Kepala Sekolah';
            document.getElementById('sigPrincipalNIP1').textContent = schoolProfile.principalNIP || '-';
            document.getElementById('sigPrincipalNIP2').textContent = schoolProfile.principalNIP || '-';
            
            // Update tanggal cetak
            updatePrintDates();
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validasi ukuran file (maks 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showToast("Ukuran file terlalu besar. Maksimal 2MB", 'error');
                return;
            }
            
            // Validasi tipe file
            if (!file.type.match('image/jpeg') && !file.type.match('image/png')) {
                showToast("Format file tidak didukung. Gunakan JPG atau PNG", 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const photoPreview = document.getElementById('photoPreview');
                const photoUploadText = document.getElementById('photoUploadText');
                const photoControls = document.getElementById('photoControls');
                
                photoPreview.src = e.target.result;
                photoPreview.style.display = 'block';
                photoUploadText.style.display = 'none';
                photoControls.style.display = 'flex';
                
                currentPhotoData = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function saveProfilePhoto() {
            if (currentPhotoData) {
                localStorage.setItem('teacherPhoto', currentPhotoData);
                updateProfileDisplay();
                showToast("Foto profil berhasil disimpan!", 'success');
            }
        }

        function removeProfilePhoto() {
            if (confirm('Hapus foto profil?')) {
                localStorage.removeItem('teacherPhoto');
                currentPhotoData = null;
                
                const photoPreview = document.getElementById('photoPreview');
                const photoUploadText = document.getElementById('photoUploadText');
                const photoControls = document.getElementById('photoControls');
                const profileAvatarImg = document.getElementById('profileAvatarImg');
                const profileAvatarInitials = document.getElementById('profileAvatarInitials');
                
                photoPreview.style.display = 'none';
                photoUploadText.style.display = 'block';
                photoControls.style.display = 'none';
                
                profileAvatarImg.style.display = 'none';
                profileAvatarInitials.style.display = 'block';
                
                document.getElementById('photoInput').value = '';
                
                updateProfileDisplay();
                showToast("Foto profil dihapus", 'warning');
            }
        }

        function saveSchoolProfile() {
            schoolProfile = {
                school: document.getElementById('schoolName').value,
                city: document.getElementById('schoolCity').value,
                principal: document.getElementById('principalName').value,
                principalNIP: document.getElementById('principalNIP').value
            };
            
            localStorage.setItem('schoolProfile', JSON.stringify(schoolProfile));
            updateProfileDisplay();
            showToast("Data Sekolah Berhasil Disimpan!", 'success');
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('journals'));
            if(history) {
                journalHistory = history.sort((a, b) => new Date(a.date) - new Date(b.date));
            }
        }

        function handleClassChange() {
            selectedStudents = [];
            renderTags();
            document.getElementById('studentSearch').value = '';
            const cls = document.getElementById('journalClass').value;
            document.getElementById('studentSearch').disabled = !cls;
            if(cls) document.getElementById('studentSearch').focus();
            else document.getElementById('suggestions').style.display = 'none';
        }

        function displaySuggestions(query, cls) {
            const sugg = document.getElementById('suggestions');
            
            if(!cls || query.length === 0) {
                sugg.style.display = 'none';
                return;
            }

            const matches = studentDatabase[cls].filter(s => 
                s.nama.toLowerCase().includes(query.toLowerCase()) && !selectedStudents.includes(s.nama)
            );

            sugg.innerHTML = '';
            if(matches.length > 0) {
                sugg.style.display = 'block';
                matches.forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.innerHTML = `<span>${m.nama}</span> <small style="color: #64748b;">${m.nis}</small>`;
                    div.addEventListener('click', () => {
                        addStudent(m.nama);
                        document.getElementById('studentSearch').value = '';
                        document.getElementById('studentSearch').focus();
                    });
                    sugg.appendChild(div);
                });
            } else {
                sugg.style.display = 'none';
            }
        }

        function addStudent(name) {
            if(!selectedStudents.includes(name)) {
                selectedStudents.push(name);
                selectedStudents.sort();
                showToast(`${name} ditambahkan`, 'info');
            }
            renderTags();
            document.getElementById('suggestions').style.display = 'none';
        }

        function removeStudent(name) {
            selectedStudents = selectedStudents.filter(s => s !== name);
            renderTags();
        }

        function renderTags() {
            const container = document.getElementById('selectedTags');
            if(selectedStudents.length === 0) {
                container.innerHTML = '<div style="color: #64748b; font-style: italic;">Belum ada siswa yang dipilih</div>';
            } else {
                container.innerHTML = selectedStudents.map(s => `
                    <div class="tag">${s} <span class="tag-remove" data-student-name="${s}">√ó</span></div>
                `).join('');
                container.querySelectorAll('.tag-remove').forEach(btn => {
                    btn.addEventListener('click', (e) => removeStudent(e.target.dataset.studentName));
                });
            }
        }

        function clearJournalForm() {
            if(confirm('Reset form input jurnal?')) {
                document.getElementById('journalForm').reset();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('journalDate').value = today;
                selectedStudents = [];
                renderTags();
                handleClassChange();
                showToast("Form berhasil direset", 'info');
            }
        }

        function saveJournalEntry() {
            const date = document.getElementById('journalDate').value;
            const kelas = document.getElementById('journalClass').value;
            const kd = document.getElementById('journalKD').value;
            
            if(!date || !kelas || !kd) {
                showToast("Harap lengkapi semua field!", 'error');
                return;
            }

            const newEntry = {
                id: Date.now(),
                date: date,
                class: kelas,
                kd: kd,
                absent: [...selectedStudents]
            };
            
            journalHistory.push(newEntry);
            journalHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
            localStorage.setItem('journals', JSON.stringify(journalHistory));
            updateProfileDisplay();
            showToast("Jurnal Berhasil Disimpan!", 'success');
            
            document.getElementById('journalForm').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('journalDate').value = today;
            selectedStudents = [];
            renderTags();
            handleClassChange();
            
            // Update tampilan jurnal hari ini
            displayTodayJournal();
            
            // Otomatis navigasi ke Jurnal Hari Ini
            setTimeout(() => {
                const todayLink = document.querySelector('.nav-link[data-section-id="jurnal-hari-ini"]');
                if (todayLink) showSection('jurnal-hari-ini', todayLink);
            }, 500);
        }

        function renderHistoryTable() {
            const filterClass = document.getElementById('printClassFilter').value;
            const tbody = document.querySelector('#historyTable tbody');
            const empty = document.getElementById('historyEmpty');
            
            tbody.innerHTML = '';

            let displayData = journalHistory;
            if(filterClass !== 'ALL') {
                displayData = journalHistory.filter(j => j.class === filterClass);
            }

            if(displayData.length === 0) {
                empty.style.display = 'block';
                return;
            }
            
            empty.style.display = 'none';
            const sortedData = [...displayData].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedData.forEach(j => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatDate(j.date)}</td>
                    <td><strong>${j.class}</strong></td>
                    <td>${j.kd}</td>
                    <td>${j.absent.length > 0 ? j.absent.join(', ') : '<span style="color:var(--success)">Hadir Semua</span>'}</td>
                    <td class="no-print">
                        <button class="btn btn-danger" style="padding:4px 8px; font-size:0.7rem;" data-journal-id="${j.id}">Hapus</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            tbody.querySelectorAll('.btn-danger[data-journal-id]').forEach(btn => {
                btn.addEventListener('click', (e) => deleteJournal(parseInt(e.target.dataset.journalId)));
            });
        }

        function populateRecapFilters() {
            const monthSelect = document.getElementById('recapMonthFilter');
            const yearSelect = document.getElementById('recapYearFilter');
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            monthSelect.innerHTML = '';
            yearSelect.innerHTML = '';

            monthNames.forEach((name, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = name;
                monthSelect.appendChild(option);
            });

            for (let i = currentYear - 5; i <= currentYear + 5; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                yearSelect.appendChild(option);
            }

            monthSelect.value = currentMonth;
            yearSelect.value = currentYear;
            
            document.getElementById('rekapMonthName').textContent = monthNames[currentMonth];
            document.getElementById('rekapYearPrint').textContent = currentYear;
        }

        function renderRecapTable() {
            const month = parseInt(document.getElementById('recapMonthFilter').value);
            const year = parseInt(document.getElementById('recapYearFilter').value);
            const classFilter = document.getElementById('recapClassFilter').value;
            const tbody = document.getElementById('recapBody');
            const thead = document.querySelector('#recapTable thead');
            const tfoot = document.getElementById('recapFoot');
            const empty = document.getElementById('recapEmpty');
            
            tbody.innerHTML = '';
            thead.innerHTML = '';
            tfoot.innerHTML = '';

            document.getElementById('rekapMonthName').textContent = monthNames[month];
            document.getElementById('rekapYearPrint').textContent = year;

            const daysInMonth = getDaysInMonth(month, year);

            // Hanya tampilkan tanggal 1-31 (full bulan)
            let headerRow = '<tr><th style="width: 40px;">No</th><th style="min-width: 150px;">Nama</th>';
            for (let i = 1; i <= daysInMonth; i++) {
                headerRow += `<th>${i}</th>`;
            }
            headerRow += '<th style="width: 80px;">Total</th></tr>';
            thead.innerHTML = headerRow;

            let studentsInScope = [];
            if (classFilter === 'ALL') {
                for (const cls in studentDatabase) {
                    studentsInScope = studentsInScope.concat(studentDatabase[cls]);
                }
            } else {
                studentsInScope = studentDatabase[classFilter] || [];
            }
            
            studentsInScope.sort((a, b) => {
                const classOrder = { 'X': 0, 'XI': 1, 'XII': 2 };
                if (a.className !== b.className) {
                    return classOrder[a.className] - classOrder[b.className];
                }
                return a.nama.localeCompare(b.nama);
            });

            if (studentsInScope.length === 0) {
                empty.style.display = 'block';
                return;
            }

            const absenceRecords = new Map(studentsInScope.map(s => [s.nama, { 
                absences: new Array(daysInMonth).fill(false),
                total: 0,
                class: s.className,
                nis: s.nis
            }]));

            let totalClassAbsences = 0;

            journalHistory.forEach(journal => {
                const journalDate = new Date(journal.date + 'T00:00:00');
                if (journalDate.getMonth() === month && journalDate.getFullYear() === year) {
                    if (classFilter === 'ALL' || journal.class === classFilter) {
                        const day = journalDate.getDate();
                        journal.absent.forEach(absentStudentName => {
                            if (absenceRecords.has(absentStudentName)) {
                                const record = absenceRecords.get(absentStudentName);
                                if (classFilter === 'ALL' || record.class === journal.class) {
                                    if (!record.absences[day - 1]) {
                                        record.absences[day - 1] = true;
                                        record.total++;
                                        totalClassAbsences++;
                                    }
                                }
                            }
                        });
                    }
                }
            });

            let studentCounter = 0;
            studentsInScope.forEach(student => {
                const record = absenceRecords.get(student.nama);
                if (!record) return;

                studentCounter++;
                let rowHtml = `<tr><td>${studentCounter}</td><td>${student.nama}</td>`; 
                for (let i = 0; i < daysInMonth; i++) {
                    rowHtml += `<td>${record.absences[i] ? '‚úì' : ''}</td>`;
                }
                rowHtml += `<td>${record.total}</td></tr>`;
                tbody.innerHTML += rowHtml;
            });

            // Hanya tampilkan total jika ada data absensi
            if (totalClassAbsences > 0) {
                let totalFooterRow = `<tr><td colspan="2"><strong>Total Ketidakhadiran</strong></td>`;
                for (let i = 1; i <= daysInMonth; i++) {
                    totalFooterRow += `<td></td>`;
                }
                totalFooterRow += `<td><strong>${totalClassAbsences}</strong></td></tr>`;
                tfoot.innerHTML = totalFooterRow;
            }

            empty.style.display = totalClassAbsences === 0 ? 'block' : 'none';
        }

        async function generatePDF(type) {
            const loading = document.getElementById('pdfLoading');
            loading.style.display = 'flex';

            try {
                let elementId, filename;
                const city = schoolProfile.city || 'Kota';
                const today = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                const fullDate = `${city}, ${today}`;
                
                // Update tanggal signature sebelum generate PDF
                document.getElementById('sigDate1').textContent = fullDate;
                document.getElementById('sigDate2').textContent = fullDate;
                
                if (type === 'jurnal') {
                    elementId = 'capture-jurnal';
                    filename = 'Jurnal_Mengajar';
                    
                    // Cek apakah ada data sebelum generate PDF
                    const filterClass = document.getElementById('printClassFilter').value;
                    let displayData = journalHistory;
                    if(filterClass !== 'ALL') {
                        displayData = journalHistory.filter(j => j.class === filterClass);
                    }
                    
                    if (displayData.length === 0) {
                        showToast("Tidak ada data jurnal untuk di-download", 'warning');
                        loading.style.display = 'none';
                        return;
                    }
                } else {
                    elementId = 'capture-rekap';
                    const selectedMonth = monthNames[parseInt(document.getElementById('recapMonthFilter').value)];
                    const selectedYear = document.getElementById('recapYearFilter').value;
                    filename = `Rekap_Absensi_${selectedMonth}_${selectedYear}`;
                    
                    // Cek apakah ada data sebelum generate PDF
                    const month = parseInt(document.getElementById('recapMonthFilter').value);
                    const year = parseInt(document.getElementById('recapYearFilter').value);
                    const classFilter = document.getElementById('recapClassFilter').value;
                    
                    let hasData = false;
                    journalHistory.forEach(journal => {
                        const journalDate = new Date(journal.date + 'T00:00:00');
                        if (journalDate.getMonth() === month && journalDate.getFullYear() === year) {
                            if (classFilter === 'ALL' || journal.class === classFilter) {
                                if (journal.absent.length > 0) {
                                    hasData = true;
                                }
                            }
                        }
                    });
                    
                    if (!hasData) {
                        showToast("Tidak ada data absensi untuk di-download", 'warning');
                        loading.style.display = 'none';
                        return;
                    }
                }

                const element = document.getElementById(elementId);
                
                // Deteksi apakah HP berdasarkan viewport width (lebih reliable)
                const isMobile = window.innerWidth <= 768;
                
                console.log("Generating PDF - Mobile:", isMobile, "Type:", type);
                
                // Simpan style asli
                const originalStyles = {
                    width: element.style.width,
                    minWidth: element.style.minWidth,
                    maxWidth: element.style.maxWidth,
                    padding: element.style.padding,
                    margin: element.style.margin
                };
                
                // Untuk HP, atur width tetap untuk A4
                if (isMobile) {
                    // Untuk tabel rekap, pastikan semua kolom terlihat
                    if (type === 'rekap') {
                        element.style.width = '1200px'; // Lebar lebih besar untuk semua hari
                        element.style.minWidth = '1200px';
                        element.style.maxWidth = '1200px';
                        element.style.overflowX = 'visible';
                    } else {
                        element.style.width = '794px'; // 794px = 210mm A4 width
                        element.style.minWidth = '794px';
                        element.style.maxWidth = '794px';
                    }
                    
                    element.style.padding = '20px';
                    element.style.margin = '0 auto';
                    element.style.boxSizing = 'border-box';
                    
                    // Pastikan signature section sejajar di HP
                    const sigSections = element.querySelectorAll('.signature-section');
                    sigSections.forEach(sig => {
                        sig.style.display = 'flex';
                        sig.style.flexDirection = 'row';
                        sig.style.justifyContent = 'space-between';
                        sig.style.alignItems = 'flex-start';
                        sig.style.gap = '20px';
                        sig.style.flexWrap = 'nowrap';
                        sig.style.width = '100%';
                        sig.style.marginTop = '30px';
                        sig.style.padding = '15px 0';
                    });
                    
                    // Atur sig-blocks agar sejajar
                    const sigBlocks = element.querySelectorAll('.sig-block');
                    sigBlocks.forEach(block => {
                        block.style.flex = '1';
                        block.style.minWidth = '45%';
                        block.style.maxWidth = '45%';
                        block.style.margin = '0';
                        block.style.padding = '0 10px';
                        block.style.textAlign = 'center';
                    });
                    
                    // Pastikan tabel bisa menampung semua hari
                    const tables = element.querySelectorAll('table');
                    tables.forEach(table => {
                        table.style.tableLayout = 'fixed';
                        table.style.width = '100%';
                    });
                }

                const canvas = await html2canvas(element, {
                    scale: isMobile ? 1 : 2, // Scale 1 untuk HP agar semua kolom terlihat
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    width: isMobile ? (type === 'rekap' ? 1200 : 794) : element.scrollWidth,
                    height: element.scrollHeight,
                    onclone: function(clonedDoc) {
                        // Sembunyikan elemen yang tidak perlu
                        clonedDoc.querySelectorAll('.no-print').forEach(el => {
                            el.style.display = 'none';
                            el.style.visibility = 'hidden';
                        });
                        
                        // Tampilkan header dan signature
                        const clonedPrintHeader = clonedDoc.querySelector(`#${elementId} .print-header`);
                        if(clonedPrintHeader) {
                            clonedPrintHeader.style.display = 'block';
                            clonedPrintHeader.style.visibility = 'visible';
                        }
                        
                        // Untuk HP, optimalkan signature
                        if (isMobile) {
                            const clonedSigSections = clonedDoc.querySelectorAll(`#${elementId} .signature-section`);
                            clonedSigSections.forEach(sig => {
                                sig.style.display = 'flex';
                                sig.style.flexDirection = 'row';
                                sig.style.justifyContent = 'space-between';
                                sig.style.alignItems = 'flex-start';
                                sig.style.gap = '20px';
                                sig.style.flexWrap = 'nowrap';
                                sig.style.width = '100%';
                                sig.style.visibility = 'visible';
                                sig.style.marginTop = '30px';
                                sig.style.padding = '15px 0';
                                sig.style.borderTop = '2px solid #000';
                            });
                            
                            const clonedSigBlocks = clonedDoc.querySelectorAll(`#${elementId} .sig-block`);
                            clonedSigBlocks.forEach(block => {
                                block.style.flex = '1';
                                block.style.minWidth = '45%';
                                block.style.maxWidth = '45%';
                                block.style.margin = '0';
                                block.style.padding = '0 10px';
                                block.style.textAlign = 'center';
                            });
                            
                            // Untuk tabel rekap, buat kolom lebih kecil
                            if (type === 'rekap') {
                                const clonedTable = clonedDoc.querySelector(`#${elementId} #recapTable`);
                                if (clonedTable) {
                                    clonedTable.style.fontSize = '7pt';
                                    clonedTable.style.width = '100%';
                                    
                                    // Atur ukuran kolom tanggal
                                    const allTh = clonedTable.querySelectorAll('th:nth-child(n+3):not(:last-child)');
                                    const allTd = clonedTable.querySelectorAll('td:nth-child(n+3):not(:last-child)');
                                    allTh.forEach(th => {
                                        th.style.width = '15px';
                                        th.style.minWidth = '15px';
                                        th.style.maxWidth = '15px';
                                        th.style.padding = '1px';
                                    });
                                    allTd.forEach(td => {
                                        td.style.width = '15px';
                                        td.style.minWidth = '15px';
                                        td.style.maxWidth = '15px';
                                        td.style.padding = '1px';
                                    });
                                }
                            }
                        }
                        
                        // Optimasi tabel untuk PDF
                        const tables = clonedDoc.querySelectorAll('table');
                        tables.forEach(table => {
                            table.style.width = '100%';
                            table.style.tableLayout = 'fixed';
                        });
                        
                        // Pastikan tidak ada elemen kosong yang memakan ruang
                        const emptyStates = clonedDoc.querySelectorAll('.empty-state');
                        emptyStates.forEach(el => {
                            el.style.display = 'none';
                            el.style.visibility = 'hidden';
                        });
                    }
                });

                const imgData = canvas.toDataURL('image/jpeg', 0.9);
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                
                // Hitung dimensi gambar
                const imgWidth = pdfWidth - 20; // Margin 10mm kiri-kanan
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // Hitung jumlah halaman
                let heightLeft = imgHeight;
                let position = 10; // Margin atas 10mm
                let pageNumber = 1;

                while (heightLeft > 0) {
                    pdf.addImage(imgData, 'JPEG', 10, position, imgWidth, imgHeight);
                    heightLeft -= pdfHeight;
                    position -= pdfHeight;
                    
                    // Tambah halaman baru jika masih ada konten
                    if (heightLeft > 0) {
                        pdf.addPage();
                        pageNumber++;
                    }
                }

                pdf.save(`${filename}_${new Date().toISOString().split('T')[0]}.pdf`);
                showToast("PDF Berhasil Didownload", 'success');

                // Reset style jika mobile
                if (isMobile) {
                    element.style.width = originalStyles.width;
                    element.style.minWidth = originalStyles.minWidth;
                    element.style.maxWidth = originalStyles.maxWidth;
                    element.style.padding = originalStyles.padding;
                    element.style.margin = originalStyles.margin;
                    element.style.overflowX = '';
                    
                    // Reset signature styles
                    const sigSections = element.querySelectorAll('.signature-section');
                    sigSections.forEach(sig => {
                        sig.style.display = '';
                        sig.style.flexDirection = '';
                        sig.style.justifyContent = '';
                        sig.style.alignItems = '';
                        sig.style.gap = '';
                        sig.style.flexWrap = '';
                        sig.style.width = '';
                        sig.style.marginTop = '';
                        sig.style.padding = '';
                        sig.style.borderTop = '';
                    });
                    
                    const sigBlocks = element.querySelectorAll('.sig-block');
                    sigBlocks.forEach(block => {
                        block.style.flex = '';
                        block.style.minWidth = '';
                        block.style.maxWidth = '';
                        block.style.margin = '';
                        block.style.padding = '';
                        block.style.textAlign = '';
                    });
                }

            } catch (err) {
                console.error('PDF Error:', err);
                showToast("Gagal membuat PDF: " + err.message, 'error');
            } finally {
                loading.style.display = 'none';
            }
        }

        function printSection(type) {
            const city = schoolProfile.city || 'Kota';
            const today = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            const fullDate = `${city}, ${today}`;
            
            // Update tanggal signature sebelum print
            document.getElementById('sigDate1').textContent = fullDate;
            document.getElementById('sigDate2').textContent = fullDate;
            
            if (type === 'jurnal') {
                // Cek apakah ada data sebelum print
                const filterClass = document.getElementById('printClassFilter').value;
                let displayData = journalHistory;
                if(filterClass !== 'ALL') {
                    displayData = journalHistory.filter(j => j.class === filterClass);
                }
                
                if (displayData.length === 0) {
                    showToast("Tidak ada data jurnal untuk di-print", 'warning');
                    return;
                }
            } else {
                // Cek apakah ada data sebelum print
                const month = parseInt(document.getElementById('recapMonthFilter').value);
                const year = parseInt(document.getElementById('recapYearFilter').value);
                const classFilter = document.getElementById('recapClassFilter').value;
                
                let hasData = false;
                journalHistory.forEach(journal => {
                    const journalDate = new Date(journal.date + 'T00:00:00');
                    if (journalDate.getMonth() === month && journalDate.getFullYear() === year) {
                        if (classFilter === 'ALL' || journal.class === classFilter) {
                            if (journal.absent.length > 0) {
                                hasData = true;
                            }
                        }
                    }
                });
                
                if (!hasData) {
                    showToast("Tidak ada data absensi untuk di-print", 'warning');
                    return;
                }
            }
            
            // Pastikan signature section sejajar sebelum print
            document.querySelectorAll('.signature-section').forEach(sig => {
                sig.style.display = 'flex';
                sig.style.flexDirection = 'row';
                sig.style.justifyContent = 'space-between';
                sig.style.alignItems = 'flex-start';
                sig.style.gap = '20px';
                sig.style.flexWrap = 'nowrap';
            });
            
            // Sembunyikan elemen yang tidak perlu saat print
            document.querySelectorAll('.no-print').forEach(el => {
                el.style.display = 'none';
                el.style.visibility = 'hidden';
            });
            
            setTimeout(() => {
                window.print();
                
                // Kembalikan tampilan setelah print
                setTimeout(() => {
                    document.querySelectorAll('.no-print').forEach(el => {
                        el.style.display = '';
                        el.style.visibility = 'visible';
                    });
                    
                    // Reset signature styles
                    document.querySelectorAll('.signature-section').forEach(sig => {
                        sig.style.display = '';
                        sig.style.flexDirection = '';
                        sig.style.justifyContent = '';
                        sig.style.alignItems = '';
                        sig.style.gap = '';
                        sig.style.flexWrap = '';
                    });
                }, 500);
            }, 100);
        }

        function exportBackup() {
            const dataToExport = {
                teacherProfile: teacherProfile,
                schoolProfile: schoolProfile,
                journals: journalHistory,
                students: students,
                teacherPhoto: currentPhotoData,
                lastCheckedDate: lastCheckedDate,
                exportDate: new Date().toISOString(),
                version: '4.0'
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_jurnal_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast("Backup Berhasil Didownload!", 'success');
        }

        function importBackup(input) {
            const file = input.files[0];
            if (!file) return;

            if(!confirm('Restore data dari backup? Data saat ini akan diganti.')) {
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if(!data.journals || !Array.isArray(data.journals)) {
                        throw new Error('Format file backup tidak valid.');
                    }
                    
                    // Restore data
                    teacherProfile = data.teacherProfile || data.profile || {};
                    schoolProfile = data.schoolProfile || {};
                    journalHistory = data.journals;
                    if(data.students) students = data.students;
                    if(data.teacherPhoto) currentPhotoData = data.teacherPhoto;
                    if(data.lastCheckedDate) lastCheckedDate = data.lastCheckedDate;
                    
                    // Save to localStorage
                    localStorage.setItem('teacherProfile', JSON.stringify(teacherProfile));
                    localStorage.setItem('schoolProfile', JSON.stringify(schoolProfile));
                    localStorage.setItem('journals', JSON.stringify(journalHistory));
                    localStorage.setItem('lastCheckedDate', lastCheckedDate);
                    if(currentPhotoData) {
                        localStorage.setItem('teacherPhoto', currentPhotoData);
                    }
                    
                    // Reload data
                    initializeApp();
                    
                    showToast("Data Berhasil Dipulihkan!", 'success');
                } catch (err) {
                    console.error('Restore Error:', err);
                    showToast("File backup tidak valid.", 'error');
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function confirmClearData() {
            if(confirm('HAPUS SEMUA DATA? Tindakan ini tidak dapat dibatalkan!')) {
                localStorage.clear();
                teacherProfile = {};
                schoolProfile = {};
                journalHistory = [];
                currentPhotoData = null;
                lastCheckedDate = new Date().toISOString().split('T')[0];
                
                // Reset form
                document.getElementById('schoolName').value = '';
                document.getElementById('schoolCity').value = '';
                document.getElementById('principalName').value = '';
                document.getElementById('principalNIP').value = '';
                
                // Reset photo
                const photoPreview = document.getElementById('photoPreview');
                const photoUploadText = document.getElementById('photoUploadText');
                const photoControls = document.getElementById('photoControls');
                photoPreview.style.display = 'none';
                photoUploadText.style.display = 'block';
                photoControls.style.display = 'none';
                
                // Reinitialize
                initializeApp();
                
                showToast("Semua data berhasil dihapus", 'warning');
            }
        }

        function deleteJournal(id) {
            if(confirm('Hapus jurnal ini?')) {
                journalHistory = journalHistory.filter(j => j.id !== id);
                localStorage.setItem('journals', JSON.stringify(journalHistory));
                updateProfileDisplay();
                displayTodayJournal();
                renderHistoryTable();
                renderRecapTable();
                showToast("Jurnal berhasil dihapus", 'warning');
            }
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr + 'T00:00:00');
            return d.toLocaleDateString('id-ID', {
                weekday: 'short', day: 'numeric', month: 'short', year: 'numeric'
            });
        }

        function getDaysInMonth(month, year) {
            return new Date(year, month + 1, 0).getDate();
        }

        function autoFillSampleData() {
            // Fill teacher profile
            teacherProfile = {
                name: 'Budi Santoso, S.Pd., M.Pd.',
                subject: 'Matematika',
                classes: 'X,XI,XII'
            };
            localStorage.setItem('teacherProfile', JSON.stringify(teacherProfile));
            
            // Fill school profile
            document.getElementById('schoolName').value = 'SMK Negeri 1 Contoh';
            document.getElementById('schoolCity').value = 'Surabaya';
            document.getElementById('principalName').value = 'Dr. Surya Wijaya, M.Pd.';
            document.getElementById('principalNIP').value = '197003211995011001';
            
            schoolProfile = {
                school: 'SMK Negeri 1 Contoh',
                city: 'Surabaya',
                principal: 'Dr. Surya Wijaya, M.Pd.',
                principalNIP: '197003211995011001'
            };
            localStorage.setItem('schoolProfile', JSON.stringify(schoolProfile));
            
            // Add sample journals
            const today = new Date().toISOString().split('T')[0];
            
            const sampleJournals = [
                { id: Date.now() + 1, date: today, class: 'X', kd: 'Materi Aljabar Lanjut', absent: ['ADI SAPUTRA', 'AULIA NUR LAELA'] },
                { id: Date.now() + 2, date: today, class: 'XI', kd: 'Pengantar Kalkulus', absent: ['Ahmad Iqbal'] },
                { id: Date.now() + 3, date: today, class: 'XII', kd: 'Statistika Inferensial', absent: ['Ahmad Maulana', 'Aliya Ayu Marlina'] },
            ];

            journalHistory = [...journalHistory, ...sampleJournals];
            journalHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
            localStorage.setItem('journals', JSON.stringify(journalHistory));

            updateProfileDisplay();
            displayTodayJournal();
            showToast("Data contoh telah diisi. Silakan simpan Data Sekolah.", 'info');
        }

        function showToast(msg, type = 'info') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            
            switch(type) {
                case 'success': t.style.background = '#22c55e'; break;
                case 'error': t.style.background = '#ef4444'; break;
                case 'warning': t.style.background = '#f59e0b'; break;
                default: t.style.background = '#3b82f6';
            }
            
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
