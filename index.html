<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aplikasi Jurnal Guru Digital</title>
    <!-- Library untuk PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --bg-body: #f1f5f9;
            --bg-sidebar: #0f172a;
            --text-sidebar: #94a3b8;
            --text-sidebar-active: #ffffff;
            --white: #ffffff;
            --border: #e2e8f0;
            --danger: #ef4444;
            --success: #22c55e;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --filter-yellow: #fef08a;
            --filter-text: #854d0e;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-body);
            color: #1e293b;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px;
            background-color: var(--bg-sidebar);
            color: var(--text-sidebar);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 1000;
            height: 100%;
        }

        .sidebar-header {
            padding: 20px;
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--white);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-links { list-style: none; padding: 20px 10px; flex: 1; }
        .nav-item { margin-bottom: 5px; }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-radius: 8px;
            color: var(--text-sidebar);
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .nav-link:hover, .nav-link.active {
            background-color: var(--primary);
            color: var(--text-sidebar-active);
        }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            position: relative;
        }

        .top-bar {
            background: var(--white);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--primary);
        }

        .page-title { font-weight: 600; font-size: 1.1rem; }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* --- SECTIONS --- */
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }

        .card {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .card-header {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
            color: #334155;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        /* --- STYLING FILTER & TOMBOL --- */
        .filter-group { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        
        .yellow-select {
            background-color: var(--filter-yellow) !important;
            border: 1px solid #eab308 !important;
            color: var(--filter-text) !important;
            font-weight: 600;
            padding: 8px 12px !important;
            outline: none;
            border-radius: 6px;
            cursor: pointer;
        }

        /* --- FORMS & BUTTONS --- */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.9rem; color: #475569; }
        
        input[type="text"], input[type="date"], select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.95rem;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            justify-content: center;
            text-decoration: none;
            transition: background 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-pdf { background: #dc2626; color: white; }
        .btn-pdf:hover { background: #b91c1c; }
        
        .backup-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
            border: 2px dashed var(--border);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            background: #f8fafc;
        }

        /* --- TABLES --- */
        .table-responsive { overflow-x: auto; border-radius: 6px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background-color: #f8fafc; font-weight: 600; color: #64748b; white-space: nowrap; }
        tr:hover { background-color: #f1f5f9; }

        /* --- SIGNATURE SECTION (TANDA TANGAN) --- */
        .signature-section {
            margin-top: 50px;
            padding: 0 20px;
            display: none; /* Disembunyikan di layar HP/Desktop biasa */
            justify-content: space-between;
            font-size: 1rem;
            color: #000;
        }
        .sig-block {
            text-align: center;
            min-width: 200px;
        }
        .sig-space {
            height: 80px;
        }

        /* --- AUTO COMPLETE & TAGS --- */
        .search-container { position: relative; }
        .suggestions {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 1px solid var(--border);
            max-height: 200px; overflow-y: auto; z-index: 50;
            box-shadow: var(--shadow);
            border-radius: 0 0 6px 6px;
        }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; }
        .suggestion-item:hover { background: #f1f5f9; }
        
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .tag { 
            background: #e0f2fe; color: #0369a1; padding: 4px 10px; 
            border-radius: 20px; font-size: 0.85rem; font-weight: 600; 
            display: flex; align-items: center; gap: 6px; 
        }
        .tag-remove { 
            cursor: pointer; background: #0ea5e9; color: white; 
            border-radius: 50%; width: 16px; height: 16px; 
            display: flex; align-items: center; justify-content: center; font-size: 10px; 
        }

        /* --- TOAST --- */
        #toast {
            position: fixed; bottom: 20px; right: 20px;
            background: #333; color: white; padding: 12px 24px;
            border-radius: 8px; z-index: 2000; opacity: 0;
            transition: opacity 0.3s; pointer-events: none;
        }
        #toast.show { opacity: 1; }

        /* --- PDF LOADING OVERLAY --- */
        .pdf-loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); color: white;
            z-index: 9999; display: none;
            flex-direction: column;
            align-items: center; justify-content: center;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- PRINT STYLES --- */
        .print-header { display: none; text-align: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #333; }
        .print-header h2 { font-size: 18pt; text-transform: uppercase; margin: 0; }
        .print-header p { font-size: 11pt; margin: 3px 0; }

        @media print {
            .sidebar, .top-bar, .btn, .search-input, .suggestions, .tags-container, .filter-group, .menu-toggle, .no-print {
                display: none !important;
            }
            body, .main-content, .content-area, .card {
                background: white; width: 100%; height: auto; overflow: visible; padding: 0; margin: 0; box-shadow: none; border: none;
            }
            .print-header { display: block !important; }
            .signature-section { display: flex !important; page-break-inside: avoid; } /* Tampilkan Tanda Tangan saat Print */
            table { width: 100%; border: 1px solid #000; }
            th, td { border: 1px solid #000; color: #000; padding: 8px; }
        }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -260px; height: 100%; width: 280px; }
            .sidebar.open { transform: translateX(260px); }
            .menu-toggle { display: block; }
            .overlay {
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 999; display: none;
            }
            .overlay.active { display: block; }
            
            .card-header { flex-direction: column; align-items: flex-start; }
            .filter-group { flex-direction: column; align-items: stretch; width: 100%; margin-top: 10px; }
            .yellow-select { width: 100%; margin-bottom: 5px; }
            .btn { width: 100%; }
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header"><span>üìö Jurnal Guru</span></div>
        <ul class="nav-links">
            <li class="nav-item"><a class="nav-link active" onclick="showSection('input-profil', this)">‚öôÔ∏è Data Sekolah</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showSection('input-jurnal', this)">‚úèÔ∏è Input Jurnal</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showSection('cetak-jurnal', this)">üñ®Ô∏è Cetak Jurnal</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showSection('rekap-absen', this)">üìä Rekap Absen</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showSection('backup-restore', this)">üíæ Backup & Restore</a></li>
        </ul>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <header class="top-bar">
            <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
            <div class="page-title" id="pageTitle">Data Sekolah</div>
            <div style="font-size: 0.8rem; color: #64748b;" id="currentDateDisplay"></div>
        </header>

        <div class="content-area">
            
            <!-- SECTION 1: PROFIL -->
            <section id="input-profil" class="section active">
                <div class="card">
                    <div class="card-header">Identitas Sekolah & Guru</div>
                    <form id="profileForm">
                        <div class="form-group"><label>Nama Sekolah</label><input type="text" id="schoolName" placeholder="SMK Negeri..." required></div>
                        <!-- Input Kota Ditambahkan -->
                        <div class="form-group"><label>Kota / Kabupaten (Untuk Tgl Laporan)</label><input type="text" id="schoolCity" placeholder="Contoh: Surabaya" required></div>
                        <div class="form-group"><label>Nama Guru</label><input type="text" id="teacherName" placeholder="Nama Bapak/Ibu Guru" required></div>
                        <div class="form-group"><label>Mata Pelajaran</label><input type="text" id="subject" placeholder="Contoh: Matematika" required></div>
                        <div class="form-group"><label>Nama Kepala Sekolah</label><input type="text" id="principalName" placeholder="Nama Kepala Sekolah" required></div>
                        <button type="submit" class="btn btn-primary" style="width:100%">üíæ Simpan Identitas</button>
                    </form>
                </div>
            </section>

            <!-- SECTION 2: INPUT JURNAL -->
            <section id="input-jurnal" class="section">
                <div class="card">
                    <div class="card-header">Catat Kegiatan Hari Ini</div>
                    <form id="journalForm">
                        <div class="form-group"><label>Tanggal</label><input type="date" id="journalDate" required></div>
                        <div class="form-group"><label>Kelas</label><select id="journalClass" required onchange="handleClassChange()"><option value="">-- Pilih Kelas --</option><option value="X">Kelas X</option><option value="XI">Kelas XI</option><option value="XII">Kelas XII</option></select></div>
                        <div class="form-group"><label>Kompetensi Dasar / Materi</label><textarea id="journalKD" rows="3" placeholder="Topik pembelajaran..." required></textarea></div>
                        <div class="form-group">
                            <label>Siswa Tidak Hadir (Cari Nama/Inisial)</label>
                            <div class="search-container">
                                <input type="text" id="studentSearch" class="search-input" placeholder="Ketik nama siswa..." autocomplete="off" disabled>
                                <div id="suggestions" class="suggestions" style="display:none;"></div>
                            </div>
                            <div id="selectedTags" class="tags-container"></div>
                            <small style="color: #64748b; font-size: 0.8rem; margin-top: 5px;">*Ketuk nama siswa untuk menambahkan ke daftar absen.</small>
                        </div>
                        <div style="margin-top: 20px;"><button type="submit" class="btn btn-primary" style="width: 100%;">Simpan Jurnal</button></div>
                    </form>
                </div>
            </section>

            <!-- SECTION 3: CETAK JURNAL -->
            <section id="cetak-jurnal" class="section">
                <!-- Wrapper untuk PDF Capture -->
                <div id="capture-jurnal">
                    <div class="print-header">
                        <h2 id="printSchoolName">Nama Sekolah</h2>
                        <p>Guru: <span id="printTeacherName">-</span> | Mapel: <span id="printSubject">-</span></p>
                        <p style="margin-top: 5px; font-weight: bold; text-decoration: underline;">LAPORAN JURNAL MENGAJAR</p>
                    </div>

                    <div class="card" style="border: none; box-shadow: none;">
                        <div class="card-header no-print-pdf" style="border-bottom: none;">
                            <span>Riwayat Jurnal</span>
                            <!-- Class no-print ditambahkan di sini agar hilang saat PDF -->
                            <div class="filter-group no-print">
                                <select id="printClassFilter" class="yellow-select" onchange="renderHistoryTable()">
                                    <option value="ALL">üè´ Semua Kelas</option>
                                    <option value="X">üìò Kelas X</option>
                                    <option value="XI">üìó Kelas XI</option>
                                    <option value="XII">üìï Kelas XII</option>
                                </select>
                                <button class="btn btn-pdf" onclick="generatePDF('jurnal')">üìÑ Download PDF</button>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table id="historyTable">
                                <thead>
                                    <tr>
                                        <th style="width: 15%;">Tanggal</th>
                                        <th style="width: 10%;">Kelas</th>
                                        <th>Materi / Kegiatan</th>
                                        <th style="width: 25%;">Absensi</th>
                                        <!-- Header Aksi juga akan dihilangkan -->
                                        <th class="no-print" style="width: 70px;">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                            <div id="historyEmpty" style="padding: 20px; text-align: center; color: #64748b;">Belum ada data jurnal.</div>
                        </div>

                        <!-- BAGIAN TANDA TANGAN (Hidden by default, shown on PDF) -->
                        <div class="signature-section no-screen">
                            <div class="sig-block">
                                <p>Mengetahui,</p>
                                <p>Kepala Sekolah</p>
                                <div class="sig-space"></div>
                                <p><b id="sigPrincipal1">Nama Kepala Sekolah</b></p>
                                <p>NIP. .......................</p>
                            </div>
                            <div class="sig-block">
                                <p id="sigDate1">Kota, Tanggal</p>
                                <p>Guru Mata Pelajaran</p>
                                <div class="sig-space"></div>
                                <p><b id="sigTeacher1">Nama Guru</b></p>
                                <p>NIP. .......................</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECTION 4: REKAP ABSEN -->
            <section id="rekap-absen" class="section">
                <!-- Wrapper untuk PDF Capture -->
                <div id="capture-rekap">
                    <div class="print-header">
                        <h2 id="rekapSchoolNameHeader">Nama Sekolah</h2>
                        <h3 style="font-size: 14pt; margin: 5px 0;">REKAPITULASI KEHADIRAN SISWA</h3>
                        <p>Tahun: <span id="rekapYear"></span></p>
                    </div>

                    <div class="card" style="border: none; box-shadow: none;">
                        <div class="card-header no-print-pdf" style="border-bottom: none;">
                            <span>Rekapitulasi</span>
                            <!-- Class no-print ditambahkan di sini -->
                            <div class="filter-group no-print">
                                <select id="recapClassFilter" class="yellow-select" onchange="renderRecapTable()">
                                    <option value="ALL">üè´ Semua Kelas</option>
                                    <option value="X">üìò Kelas X</option>
                                    <option value="XI">üìó Kelas XI</option>
                                    <option value="XII">üìï Kelas XII</option>
                                </select>
                                <button class="btn btn-pdf" onclick="generatePDF('rekap')">üìÑ Download PDF</button>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table id="recapTable">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">No</th>
                                        <th>Nama Siswa</th>
                                        <th>Kelas</th>
                                        <th style="width: 100px; text-align: center;">Jml Absen</th>
                                    </tr>
                                </thead>
                                <tbody id="recapBody">
                                    <!-- Data Rekap -->
                                </tbody>
                            </table>
                            <div id="recapEmpty" style="padding: 20px; text-align: center; color: #64748b;">Tidak ada data siswa yang absen.</div>
                        </div>

                        <!-- BAGIAN TANDA TANGAN (Hidden by default, shown on PDF) -->
                        <div class="signature-section no-screen">
                            <div class="sig-block">
                                <p>Mengetahui,</p>
                                <p>Kepala Sekolah</p>
                                <div class="sig-space"></div>
                                <p><b id="sigPrincipal2">Nama Kepala Sekolah</b></p>
                                <p>NIP. .......................</p>
                            </div>
                            <div class="sig-block">
                                <p id="sigDate2">Kota, Tanggal</p>
                                <p>Guru Mata Pelajaran</p>
                                <div class="sig-space"></div>
                                <p><b id="sigTeacher2">Nama Guru</b></p>
                                <p>NIP. .......................</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECTION 5: BACKUP & RESTORE -->
            <section id="backup-restore" class="section">
                <div class="card">
                    <div class="card-header">Backup & Restore Data</div>
                    <div class="backup-area">
                        <div>
                            <h3>üíæ Backup Data</h3>
                            <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 10px;">Download data jurnal ke file .json</p>
                            <button class="btn btn-primary" onclick="exportBackup()">Download Backup</button>
                        </div>
                        <hr style="border: 0; border-top: 1px solid #ddd;">
                        <div>
                            <h3>üìÇ Restore Data</h3>
                            <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 10px;">Upload file .json untuk mengembalikan data</p>
                            <input type="file" id="fileInput" accept=".json" style="display:none" onchange="importBackup(this)">
                            <button class="btn btn-success" onclick="document.getElementById('fileInput').click()">Pilih File</button>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <!-- TOAST & LOADING -->
    <div id="toast">Pesan</div>
    <div id="pdfLoading" class="pdf-loading">
        <div class="spinner"></div>
        <div style="font-weight: bold;">Sedang Membuat PDF...</div>
        <small>Mohon tunggu sebentar</small>
    </div>

    <script>
        // --- DATA SISWA ---
        let students = [
            { nis: '0094789075', nama: 'ADI SAPUTRA', kelas: 'X (Sepuluh)' },
            { nis: '0096019190', nama: 'AULIA NUR LAELA', kelas: 'X (Sepuluh)' },
            { nis: '0107301719', nama: 'CIPA NADIA SALMA', kelas: 'X (Sepuluh)' },
            { nis: '0088133836', nama: 'DEDI IRAWAN', kelas: 'X (Sepuluh)' },
            { nis: '0097790486', nama: 'FAREL SAPUTERA', kelas: 'X (Sepuluh)' },
            { nis: '0106097706', nama: 'ISMAWATI DWI ANGGRAINI', kelas: 'X (Sepuluh)' },
            { nis: '0085852231', nama: 'IRFAN', kelas: 'X (Sepuluh)' },
            { nis: '0092200897', nama: 'LUTHFI HAKIM', kelas: 'X (Sepuluh)' },
            { nis: '0109081925', nama: 'M.ADITYA PRAYOGA', kelas: 'X (Sepuluh)' },
            { nis: '0094433103', nama: 'M.AL IMRON', kelas: 'X (Sepuluh)' },
            { nis: '0097848607', nama: 'MOHAMAT HARIS SETIAWAN', kelas: 'X (Sepuluh)' },
            { nis: '0082735425', nama: 'MOHAMAD RIKI SAPUTRA', kelas: 'X (Sepuluh)' },
            { nis: '0102522253', nama: 'RADITYA DANU PRATAMA', kelas: 'X (Sepuluh)' },
            { nis: '0102235604', nama: 'RIDHO FIRMANSYAH', kelas: 'X (Sepuluh)' },
            { nis: '0099798429', nama: 'RIZKI CAHYO SUGENG WIBOWO', kelas: 'X (Sepuluh)' },
            { nis: '0000000316', nama: 'RIZAL ABDUL HAQ', kelas: 'X (Sepuluh)' },
            { nis: '0106667835', nama: 'SAFA AULIA PUTRI', kelas: 'X (Sepuluh)' },
            { nis: '0105199297', nama: 'SHINTA SASTYA WATI', kelas: 'X (Sepuluh)' },
            { nis: '3106050813', nama: 'TIYAS FARIDA SARI', kelas: 'X (Sepuluh)' },
            { nis: '0095977397', nama: 'FAIS DAROIN', kelas: 'X (Sepuluh)' },
            { nis: '0095046784', nama: 'YULIA MUSLIMATUS SADIYAH', kelas: 'X (Sepuluh)' },
            { nis: '0084903816', nama: 'Ahmad Iqbal', kelas: 'XI (Sebelas)' },
            { nis: '0088606301', nama: 'Ahmad Ramadhani', kelas: 'XI (Sebelas)' },
            { nis: '1000000001', nama: 'Argi Setiawan', kelas: 'XI (Sebelas)' },
            { nis: '0081098360', nama: 'Aisyah Lu\'lu\'ul Husna', kelas: 'XI (Sebelas)' },
            { nis: '0095627591', nama: 'Anggun Puspita Anggraini', kelas: 'XI (Sebelas)' },
            { nis: '0089314202', nama: 'Dafa', kelas: 'XI (Sebelas)' },
            { nis: '0091007309', nama: 'Devita Anjani', kelas: 'XI (Sebelas)' },
            { nis: '2000000002', nama: 'Ferdi Kurniawan', kelas: 'XI (Sebelas)' },
            { nis: '3000000003', nama: 'Fitra Afriza', kelas: 'XI (Sebelas)' },
            { nis: '0084423897', nama: 'Indah Kasturi Kusuma Putri', kelas: 'XI (Sebelas)' },
            { nis: '0098669866', nama: 'Lefiyana Juwita', kelas: 'XI (Sebelas)' },
            { nis: '0085606025', nama: 'Marchfel Firdiyansah', kelas: 'XI (Sebelas)' },
            { nis: '0089725108', nama: 'Melinda Kusuma Dewi', kelas: 'XI (Sebelas)' },
            { nis: '0092585298', nama: 'M.Yudha Rizki Iftori', kelas: 'XI (Sebelas)' },
            { nis: '0074048074', nama: 'Mohamad Ibnu Rosid', kelas: 'XI (Sebelas)' },
            { nis: '0083168310', nama: 'M.Bisma Mega Nanda', kelas: 'XI (Sebelas)' },
            { nis: '0095212808', nama: 'M.Rizki Ramadhani', kelas: 'XI (Sebelas)' },
            { nis: '0000000004', nama: 'M.Fiki Darmawan', kelas: 'XI (Sebelas)' },
            { nis: '3095650322', nama: 'M.Badru Muwafaq', kelas: 'XI (Sebelas)' },
            { nis: '0095475420', nama: 'Rima', kelas: 'XI (Sebelas)' },
            { nis: '0095395423', nama: 'Rima Ulvania', kelas: 'XI (Sebelas)' },
            { nis: '0091673355', nama: 'Riski Munandar', kelas: 'XI (Sebelas)' },
            { nis: '0064036686', nama: 'Siti Miftakhul Makmuroh', kelas: 'XI (Sebelas)' },
            { nis: '0091403540', nama: 'Tomi Jadmiko', kelas: 'XI (Sebelas)' },
            { nis: '0086855084', nama: 'Tia Dwi Saputri', kelas: 'XI (Sebelas)' },
            { nis: '0000000005', nama: 'Wafiq Khariri', kelas: 'XI (Sebelas)' },
            { nis: '0095475420', nama: 'Yeni Winarni', kelas: 'XI (Sebelas)' },
            { nis: '0000000006', nama: 'Ainun Nadhiroh', kelas: 'XI (Sebelas)' },
            { nis: '0098781514', nama: 'Habibatus Zakia', kelas: 'XI (Sebelas)' },
            { nis: '3096763981', nama: 'Dwi Fatimah', kelas: 'XI (Sebelas)' },
            { nis: '3085136071', nama: 'M.Akbar Panjalu', kelas: 'XI (Sebelas)' },
            { nis: '0000000007', nama: 'Angga Dwi Saputra', kelas: 'XI (Sebelas)' },
            { nis: '0077667204', nama: 'Ahmad Maulana', kelas: 'XII (dua Belas)' },
            { nis: '0085214724', nama: 'Aliya Ayu Marlina', kelas: 'XII (dua Belas)' },
            { nis: '0087149069', nama: 'Aprilia Winanti', kelas: 'XII (dua Belas)' },
            { nis: '0082699089', nama: 'Bagas Setiawan', kelas: 'XII (dua Belas)' },
            { nis: '0068818482', nama: 'Bagus Akbar Rani', kelas: 'XII (dua Belas)' },
            { nis: '0088041522', nama: 'Binti Lutfiyah Zakiyah', kelas: 'XII (dua Belas)' },
            { nis: '0087100213', nama: 'Cantika Dwi Jayanti', kelas: 'XII (dua Belas)' },
            { nis: '0073724648', nama: 'Dennis Prasetiyo', kelas: 'XII (dua Belas)' },
            { nis: '0073965350', nama: 'Disky Ramadani', kelas: 'XII (dua Belas)' },
            { nis: '0072676706', nama: 'Ega Saputra', kelas: 'XII (dua Belas)' },
            { nis: '0085103057', nama: 'Eka Putri Febriani', kelas: 'XII (dua Belas)' },
            { nis: '0083708627', nama: 'Endra Saputra', kelas: 'XII (dua Belas)' },
            { nis: '0081159769', nama: 'Farid Ahmad Faisal', kelas: 'XII (dua Belas)' },
            { nis: '0084757704', nama: 'Maulana Dava', kelas: 'XII (dua Belas)' },
            { nis: '0000000008', nama: 'Maya Safitri', kelas: 'XII (dua Belas)' },
            { nis: '0077167251', nama: 'Miranti', kelas: 'XII (dua Belas)' },
            { nis: '0072775329', nama: 'Muhammad Aldino Ama Rasya', kelas: 'XII (dua Belas)' },
            { nis: '0082727230', nama: 'Muhammad Ahya', kelas: 'XII (dua Belas)' },
            { nis: '0081846871', nama: 'Mohamad Dendi Firmanto', kelas: 'XII (dua Belas)' },
            { nis: '0084244287', nama: 'Muhamad Misbahul Munir', kelas: 'XII (dua Belas)' },
            { nis: '0089726548', nama: 'Muhammad Rejaki', kelas: 'XII (dua Belas)' },
            { nis: '0077347477', nama: 'Mohammad Sulton Al-azhar', kelas: 'XII (dua Belas)' },
            { nis: '0085214724', nama: 'Nanda Ayu Ningsih', kelas: 'XII (dua Belas)' },
            { nis: '0000000012', nama: 'Nayla Amin', kelas: 'XII (dua Belas)' },
            { nis: '0071174694', nama: 'Rahma Wulandari', kelas: 'XII (dua Belas)' },
            { nis: '0084479963', nama: 'Rendi Hidayat', kelas: 'XII (dua Belas)' },
            { nis: '0088343077', nama: 'Sahal Wahyudin', kelas: 'XII (dua Belas)' },
            { nis: '0000000009', nama: 'Shera Aurelia Sariana', kelas: 'XII (dua Belas)' },
            { nis: '0070226573', nama: 'Sulamanul Jamal', kelas: 'XII (dua Belas)' },
            { nis: '0075282696', nama: 'Tiara Saputri', kelas: 'XII (dua Belas)' },
            { nis: '0084034253', nama: 'Wahyuni Naila Ngilma', kelas: 'XII (dua Belas)' },
            { nis: '0087602782', nama: 'Laura Meliyana Dewi', kelas: 'XII (dua Belas)' },
            { nis: '0000000010', nama: 'EKO NUZULUL MISBAH', kelas: 'XII (dua Belas)' },
            { nis: '0000000011', nama: 'MUHAMAD KHOIRUR ROZIKIN', kelas: 'XII (dua Belas)' }
        ];

        // Grouping Data
        let studentDatabase = { 'X': [], 'XI': [], 'XII': [] };
        let selectedStudents = [];
        let journalHistory = [];

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('journalDate').value = new Date().toISOString().split('T')[0];
            
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDateDisplay').textContent = new Date().toLocaleDateString('id-ID', options);
            document.getElementById('rekapYear').textContent = new Date().getFullYear();

            loadProfile();
            groupStudents();
            loadHistory();
        });

        // Navigation
        function showSection(sectionId, navElement) {
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            navElement.classList.add('active');
            document.getElementById('pageTitle').textContent = navElement.innerText.trim();

            if(window.innerWidth <= 768) toggleSidebar();

            if(sectionId === 'cetak-jurnal') renderHistoryTable();
            if(sectionId === 'rekap-absen') {
                const school = document.getElementById('schoolName').value || 'Nama Sekolah';
                document.getElementById('rekapSchoolNameHeader').textContent = school;
                renderRecapTable();
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        // --- LOGIC DATABASE SISWA ---
        function groupStudents() {
            students.forEach(s => {
                let key = '';
                const k = s.kelas.toLowerCase();
                if (k.includes('sepuluh') || k === 'x') key = 'X';
                else if (k.includes('sebelas') || k === 'xi') key = 'XI';
                else if (k.includes('dua belas') || k === 'xii') key = 'XII';
                
                if(key && studentDatabase[key]) studentDatabase[key].push(s);
            });
        }

        // --- LOCAL STORAGE & PROFIL ---
        function saveToLocalStorage() {
            const profile = {
                school: document.getElementById('schoolName').value,
                city: document.getElementById('schoolCity').value,
                teacher: document.getElementById('teacherName').value,
                subject: document.getElementById('subject').value,
                principal: document.getElementById('principalName').value
            };
            localStorage.setItem('teacherProfile', JSON.stringify(profile));
            localStorage.setItem('journals', JSON.stringify(journalHistory));
        }

        function loadProfile() {
            const profile = JSON.parse(localStorage.getItem('teacherProfile'));
            if(profile) {
                document.getElementById('schoolName').value = profile.school || '';
                document.getElementById('schoolCity').value = profile.city || '';
                document.getElementById('teacherName').value = profile.teacher || '';
                document.getElementById('subject').value = profile.subject || '';
                document.getElementById('principalName').value = profile.principal || '';

                // Set Text untuk Print Header & Tanda Tangan
                document.getElementById('printSchoolName').textContent = profile.school || 'Nama Sekolah';
                document.getElementById('printTeacherName').textContent = profile.teacher || '-';
                document.getElementById('printSubject').textContent = profile.subject || '-';
                
                // Isi Nama di Tanda Tangan
                ['sigPrincipal1', 'sigPrincipal2'].forEach(id => {
                    document.getElementById(id).textContent = profile.principal || 'Nama Kepala Sekolah';
                });
                ['sigTeacher1', 'sigTeacher2'].forEach(id => {
                    document.getElementById(id).textContent = profile.teacher || 'Nama Guru';
                });
            }
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('journals'));
            if(history) journalHistory = history;
        }

        document.getElementById('profileForm').addEventListener('submit', (e) => {
            e.preventDefault();
            saveToLocalStorage();
            loadProfile();
            showToast("Profil Sekolah Disimpan!");
        });

        // --- INPUT JURNAL ---
        function handleClassChange() {
            selectedStudents = [];
            renderTags();
            document.getElementById('studentSearch').value = '';
            const cls = document.getElementById('journalClass').value;
            document.getElementById('studentSearch').disabled = !cls;
            if(cls) document.getElementById('studentSearch').focus();
        }

        document.getElementById('studentSearch').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const cls = document.getElementById('journalClass').value;
            const sugg = document.getElementById('suggestions');
            
            if(!cls || query.length === 0) {
                sugg.style.display = 'none';
                return;
            }

            const matches = studentDatabase[cls].filter(s => 
                s.nama.toLowerCase().includes(query) && !selectedStudents.includes(s.nama)
            );

            sugg.innerHTML = '';
            if(matches.length > 0) {
                sugg.style.display = 'block';
                matches.forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.innerHTML = `<span>${m.nama}</span> <small>${m.nis}</small>`;
                    div.onclick = () => {
                        addStudent(m.nama);
                        document.getElementById('studentSearch').focus();
                    };
                    sugg.appendChild(div);
                });
            } else {
                sugg.style.display = 'none';
            }
        });

        function addStudent(name) {
            if(!selectedStudents.includes(name)) selectedStudents.push(name);
            renderTags();
            document.getElementById('studentSearch').value = '';
            document.getElementById('suggestions').style.display = 'none';
        }

        function removeStudent(name) {
            selectedStudents = selectedStudents.filter(s => s !== name);
            renderTags();
        }

        function renderTags() {
            const container = document.getElementById('selectedTags');
            container.innerHTML = selectedStudents.map(s => `
                <div class="tag">${s} <span class="tag-remove" onclick="removeStudent('${s}')">√ó</span></div>
            `).join('');
        }

        document.getElementById('journalForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const newEntry = {
                id: Date.now(),
                date: document.getElementById('journalDate').value,
                class: document.getElementById('journalClass').value,
                kd: document.getElementById('journalKD').value,
                absent: [...selectedStudents]
            };
            journalHistory.push(newEntry);
            saveToLocalStorage();
            showToast("Jurnal Berhasil Disimpan!");
            
            e.target.reset();
            document.getElementById('journalDate').value = new Date().toISOString().split('T')[0];
            selectedStudents = [];
            renderTags();
            handleClassChange();
        });

        // --- TABLE RENDER ---
        function renderHistoryTable() {
            const filterClass = document.getElementById('printClassFilter').value;
            const tbody = document.querySelector('#historyTable tbody');
            const empty = document.getElementById('historyEmpty');
            
            tbody.innerHTML = '';

            let displayData = journalHistory;
            if(filterClass !== 'ALL') {
                displayData = journalHistory.filter(j => j.class === filterClass);
            }

            if(displayData.length === 0) {
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';

            [...displayData].reverse().forEach(j => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatDate(j.date)}</td>
                    <td><strong>${j.class}</strong></td>
                    <td>${j.kd}</td>
                    <td>${j.absent.length > 0 ? j.absent.join(', ') : '<span style="color:var(--success)">Hadir Semua</span>'}</td>
                    <td class="no-print">
                        <button class="btn btn-danger" style="padding:4px 8px; font-size:0.7rem;" onclick="deleteJournal(${j.id})">Hapus</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderRecapTable() {
            const filterClass = document.getElementById('recapClassFilter').value;
            const tbody = document.getElementById('recapBody');
            const empty = document.getElementById('recapEmpty');
            
            tbody.innerHTML = '';
            let recapMap = {}; 

            journalHistory.forEach(j => {
                if (filterClass !== 'ALL' && j.class !== filterClass) return;
                j.absent.forEach(studentName => {
                    if (recapMap[studentName]) {
                        recapMap[studentName].count++;
                    } else {
                        recapMap[studentName] = { count: 1, class: j.class };
                    }
                });
            });

            let recapArray = Object.keys(recapMap).map(name => ({
                name: name,
                ...recapMap[name]
            }));

            recapArray.sort((a, b) => {
                if (a.class !== b.class) return a.class.localeCompare(b.class);
                return a.name.localeCompare(b.name);
            });

            if (recapArray.length === 0) {
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';

            recapArray.forEach((data, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${data.name}</td>
                    <td><strong>${data.class}</strong></td>
                    <td style="text-align: center;">
                        <span class="tag" style="background:var(--danger); color:white; justify-content:center;">${data.count}</span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- PDF GENERATION LOGIC ---
        function generatePDF(type) {
            const loading = document.getElementById('pdfLoading');
            loading.style.display = 'flex';

            setTimeout(() => {
                let elementId, filename;
                
                // Update Tanggal Tanda Tangan Otomatis
                const city = document.getElementById('schoolCity').value || 'Kota';
                const today = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                const fullDate = `${city}, ${today}`;
                
                if (type === 'jurnal') {
                    elementId = 'capture-jurnal';
                    filename = 'Jurnal_Mengajar';
                    document.getElementById('sigDate1').textContent = fullDate;
                } else {
                    elementId = 'capture-rekap';
                    filename = 'Rekap_Absensi';
                    document.getElementById('sigDate2').textContent = fullDate;
                }

                const element = document.getElementById(elementId);

                html2canvas(element, {
                    scale: 2,
                    windowWidth: 1200, // FORCE DESKTOP VIEW
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    onclone: function(clonedDoc) {
                        // Sembunyikan tombol & filter
                        clonedDoc.querySelectorAll('.no-print').forEach(el => el.style.display = 'none');
                        clonedDoc.querySelectorAll('.no-print-pdf').forEach(el => el.style.borderBottom = 'none');

                        // Tampilkan Header & Tanda Tangan
                        const printHeader = clonedDoc.querySelector('.print-header');
                        if(printHeader) printHeader.style.display = 'block';

                        // --- BAGIAN PENTING: MUNCULKAN TANDA TANGAN ---
                        const sigSections = clonedDoc.querySelectorAll('.signature-section');
                        sigSections.forEach(sig => sig.style.display = 'flex');

                        // Fix Tabel Overflow
                        const clonedElement = clonedDoc.getElementById(elementId);
                        const tables = clonedElement.querySelectorAll('.table-responsive');
                        tables.forEach(t => {
                            t.style.overflow = 'visible';
                            t.style.display = 'block';
                            t.style.width = '100%';
                        });
                        clonedElement.style.width = '1100px'; 
                        clonedElement.style.padding = '20px';
                    }
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/jpeg', 1.0);
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    const imgWidth = 210; 
                    const pageHeight = 297; 
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft > 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    pdf.save(`${filename}_${new Date().toISOString().split('T')[0]}.pdf`);
                    loading.style.display = 'none';
                    showToast("PDF Berhasil Didownload");
                }).catch(err => {
                    console.error(err);
                    loading.style.display = 'none';
                    alert("Gagal membuat PDF. Silakan coba lagi.");
                });
            }, 500); 
        }

        // --- BACKUP & RESTORE ---
        function exportBackup() {
            const dataToExport = {
                profile: JSON.parse(localStorage.getItem('teacherProfile')),
                journals: journalHistory,
                date: new Date().toISOString()
            };
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_jurnal_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast("Backup Didownload!");
        }

        function importBackup(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.profile) localStorage.setItem('teacherProfile', JSON.stringify(data.profile));
                    if(data.journals) journalHistory = data.journals;
                    
                    saveToLocalStorage();
                    loadProfile();
                    loadHistory();
                    renderHistoryTable();
                    
                    showToast("Data Berhasil Dipulihkan!");
                } catch (err) {
                    alert("File backup tidak valid.");
                }
            };
            reader.readAsText(file);
        }

        // --- UTILS ---
        function deleteJournal(id) {
            if(confirm('Hapus jurnal ini?')) {
                journalHistory = journalHistory.filter(j => j.id !== id);
                saveToLocalStorage();
                renderHistoryTable();
                showToast("Data Dihapus");
            }
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'});
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
